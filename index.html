<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Search Terms Analytics</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- Libs -->
<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<style>
:root{
  --bg:#0f1216; --panel:#161b22; --text:#e7ecf3; --muted:#9aa6b2; --accent:#2563eb;
  --ok:#36d399; --danger:#ef4444; --border:#273043; --chip:#1c2432;
  --border-strong:color-mix(in srgb, var(--text) 40%, var(--border));
  --shadow:0 8px 24px rgba(0,0,0,.35);
  --header-grad: linear-gradient(180deg, rgba(255,255,255,.03) 0%, rgba(255,255,255,0) 100%);
  --btnText:#fff;
  --chartsGap:12px;
  --modeBtnBg:#fff;
  --modeIcon:#000;
}
body.light{
  --bg:#f7f9fc; --panel:#ffffff; --text:#0f172a; --muted:#475569; --accent:#2563eb;
  --ok:#059669; --danger:#dc2626; --border:#e2e8f0; --chip:#eef2f7;
  --border-strong:color-mix(in srgb, var(--text) 35%, var(--border));
  --shadow:0 6px 18px rgba(15,23,42,.08);
  --header-grad: linear-gradient(180deg, rgba(15,23,42,.06) 0%, rgba(15,23,42,0) 100%);
  --btnText:#0f172a;
  --modeBtnBg:#000;
  --modeIcon:#fff;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font:13.5px/1.45 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans";color:var(--text);background:var(--bg);display:flex;flex-direction:column;min-height:100%}
[hidden]{display:none !important}
h1{margin:0;font-weight:800;letter-spacing:.2px}

/* Buttons */
button{border:1px solid var(--border);background:var(--panel);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;transition:transform .12s, box-shadow .25s, background .2s, border-color .2s}
button:hover{transform:translateY(-1px)}
button:disabled{opacity:.5;cursor:not-allowed}
#resetFilters{display:none}
.btn-filters,.btn-reset{display:inline-flex;align-items:center;gap:8px;padding:10px 16px;border-radius:999px;border:1px solid var(--border-strong);background:color-mix(in srgb,var(--chip) 70%, var(--panel));color:var(--text);font-weight:700;box-shadow:var(--shadow);transition:transform .15s ease, box-shadow .25s ease, background .2s ease}
.btn-filters:hover,.btn-reset:hover{background:color-mix(in srgb,var(--chip) 90%, var(--panel));box-shadow:0 12px 28px rgba(0,0,0,.28)}
.btn-filters:focus-visible,.btn-reset:focus-visible{outline:2px solid var(--accent);outline-offset:3px}
.btn-primary{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(180deg, var(--accent), color-mix(in srgb, var(--accent) 85%, #000));color:#fff !important;border-color:transparent;box-shadow:0 6px 18px rgba(37,99,235,.25)}
.btn-success{background:linear-gradient(180deg, var(--ok), color-mix(in srgb, var(--ok) 78%, #000)) !important;color:#fff !important;border-color:color-mix(in srgb, var(--ok) 60%, #000) !important;box-shadow:0 8px 22px color-mix(in srgb, var(--ok) 35%, transparent)}
.btn-success:hover{box-shadow:0 14px 32px color-mix(in srgb, var(--ok) 45%, transparent);transform:translateY(-2px)}
.btn-outline{display:inline-flex;align-items:center;gap:8px;background:transparent;border-color:var(--btnText);color:var(--btnText)}
/* icon-only theme button */
.btn-mode{display:inline-flex;align-items:center;gap:0;border-radius:14px;padding:10px;border:1px solid var(--modeBtnBg);background:var(--modeBtnBg);color:var(--modeIcon);width:42px;justify-content:center}

/* Header */
.app-header{display:flex;align-items:center;justify-content:space-between;padding:12px clamp(14px,3vw,28px);border-bottom:1px solid var(--border);background:var(--header-grad);position:sticky;top:0;backdrop-filter:blur(6px);z-index:20}
.actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
body:not(.has-data) .app-header{display:none}

/* Layout */
#contentWrap{flex:1;display:flex;flex-direction:column;gap:14px;padding:12px clamp(14px,3vw,28px) 28px}
body:not(.has-data) #contentWrap{justify-content:center;padding:0 18px}
.empty-state{display:none;text-align:center;font-weight:600;color:var(--muted);line-height:1.6;max-width:520px;margin:0 auto;font-size:15px}
.empty-state span{color:var(--accent);cursor:pointer;text-decoration:underline;font-weight:700}
.empty-state span:focus-visible{outline:2px solid var(--accent);outline-offset:4px;border-radius:4px}
body:not(.has-data) #emptyState{display:flex;align-items:center;justify-content:center;min-height:60vh}
body.has-data #emptyState{display:none}
body:not(.has-data) #topLine,
body:not(.has-data) #kpiSection,
body:not(.has-data) #pivotSection{display:none !important}

/* Topline */
.topline{display:flex;flex-direction:column;align-items:flex-start;gap:12px;padding:8px clamp(14px,3vw,28px)}
body.has-data #tipPill{display:none !important}
.topline-controls{display:flex;flex-wrap:wrap;align-items:center;gap:12px;width:100%}
.pivot-tabs-bar{display:flex;align-items:center;justify-content:flex-start;flex:1 1 auto;min-width:0}
.pivot-tabs{display:inline-flex;align-items:center;gap:6px;padding:4px;border-radius:14px;border:1px solid var(--border);background:var(--panel);box-shadow:var(--shadow)}
.pivot-tab{border:0;background:transparent;color:var(--muted);font-weight:700;padding:8px 16px;border-radius:10px;cursor:pointer;transition:color .2s, background .2s, transform .12s;min-width:0}
.pivot-tab:hover{color:var(--text);background:var(--chip);transform:translateY(-1px)}
.pivot-tab.is-active{color:#fff;background:linear-gradient(180deg,var(--accent),color-mix(in srgb,var(--accent) 85%,#000))}
.pivot-tab:focus-visible{outline:2px solid var(--accent);outline-offset:3px}
.pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;background:var(--chip);border:1px solid var(--border);border-radius:999px;color:var(--muted)}
.months-wrap{display:inline-flex;align-items:center;gap:6px;margin-left:auto}
.month-dd{position:relative}
.month-dd .dd-control{min-width:160px;display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:var(--panel);cursor:pointer}
.month-dd .dd-panel{position:absolute;top:calc(100% + 6px);right:0;z-index:40;background:var(--panel);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);width:240px;display:none;max-height:360px;overflow:auto}
.month-dd.open .dd-panel{display:block}
.month-row{display:grid;grid-template-columns:auto 1fr;gap:10px;align-items:center;padding:8px 12px}
.month-row:hover{background:var(--chip)}
.month-row input{accent-color:var(--accent)}
.month-name{font-weight:700;color:var(--text)}
.month-custom{padding:10px;border-top:1px solid var(--border);background:color-mix(in srgb,var(--panel) 90%, var(--chip));display:grid;gap:10px}
.month-custom-btn{width:100%;border:1px dashed var(--border);background:transparent;color:var(--accent);font-weight:700;border-radius:10px;padding:10px 12px;display:flex;align-items:center;justify-content:center;gap:6px}
.month-custom-btn:hover{background:color-mix(in srgb,var(--chip) 80%, transparent)}
.month-range-panel{border:1px solid var(--border);border-radius:12px;padding:10px;background:color-mix(in srgb,var(--panel) 85%, var(--chip));box-shadow:inset 0 1px 0 color-mix(in srgb,var(--text) 6%, transparent)}
.month-range-fields{display:flex;flex-direction:column;gap:12px}
.month-range-fields label{display:flex;flex-direction:column;gap:4px;font-weight:600;color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:.4px}
.month-range-fields input{border:1px solid var(--border);border-radius:8px;padding:8px 10px;background:var(--panel);color:var(--text);width:100%}
.month-range-actions{display:flex;gap:8px;margin-top:10px}
.month-range-apply,.month-range-clear{flex:1;border-radius:9px;font-weight:700;padding:8px 12px}
.month-range-apply{background:linear-gradient(180deg,var(--accent),color-mix(in srgb,var(--accent) 80%,#000));color:#fff;border-color:transparent;box-shadow:0 8px 20px rgba(37,99,235,.25)}
.month-range-apply:hover{box-shadow:0 12px 24px rgba(37,99,235,.3)}
.month-range-clear{background:transparent;border:1px solid var(--border-strong);color:var(--muted)}
.month-range-clear:hover{background:color-mix(in srgb,var(--chip) 85%, transparent)}

/* KPIs */
.kpis{padding:4px clamp(14px,3vw,26px) 8px;display:grid;grid-template-columns:repeat(8,minmax(120px,1fr));gap:10px}
.kpi{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:8px 10px;box-shadow:var(--shadow);min-height:68px;display:flex;flex-direction:column;justify-content:space-between}
.kpi .label{font-weight:700;color:var(--muted);font-size:12.5px}
.kpi .value{font-size:20px;font-weight:700;letter-spacing:.1px}
.kpi.small .value{font-size:20px}


/* Pivot table */
.pivot{padding:6px clamp(14px,3vw,26px) 20px;display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:var(--chartsGap);align-items:start;grid-auto-rows:var(--pivot-auto-rows,auto);grid-auto-flow:row dense}
.pivot[data-mode="overview"] #pivotCustTypeCard,
.pivot[data-mode="overview"] #pivotPlacementCard{display:none !important}
.pivot[data-mode="overview"] .pivot-conversion,
.pivot[data-mode="overall"] .pivot-conversion{display:none !important}
.pivot[data-mode="conversion"] #pivotStoreCard,
.pivot[data-mode="conversion"] #pivotLoCard,
.pivot[data-mode="conversion"] #pivotCustTypeCard,
.pivot[data-mode="conversion"] #pivotCatCard,
.pivot[data-mode="conversion"] #pivotPlacementCard{display:none !important}
@media(min-width:960px){
  .pivot[data-mode="overall"]{grid-template-columns:repeat(2,minmax(0,1fr));}
  .pivot[data-mode="overall"] .pivot-card{grid-column:1 / -1;}
  .pivot[data-mode="overall"] .pivot-overall-left{grid-column:1 / 2;}
  .pivot[data-mode="overall"] .pivot-overall-right{grid-column:2 / 3;}
  .pivot[data-mode="campaignPortfolio"]{grid-template-columns:repeat(2,minmax(0,1fr));}
  .pivot[data-mode="conversion"]{grid-template-columns:repeat(2,minmax(0,1fr));}
}
.chart-card{position:relative;background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px 12px 10px;box-shadow:var(--shadow);display:flex;flex-direction:column;overflow:hidden}
.chart-title{font-weight:700;margin-bottom:8px;color:var(--muted);display:flex;align-items:center;justify-content:space-between;gap:10px}
.chart-title-text{flex:1;min-width:0}
.pivot-copy-btn{position:relative;display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;border-radius:9px;border:1px solid var(--border-strong);background:color-mix(in srgb,var(--panel) 75%, var(--chip));color:var(--muted);cursor:pointer;transition:background .2s ease, color .2s ease, transform .12s ease, box-shadow .25s ease, border-color .2s ease}
.pivot-copy-btn .pivot-copy-icon{font-size:16px;line-height:1}
.pivot-copy-btn:hover{background:color-mix(in srgb,var(--chip) 88%, var(--panel));color:var(--text);transform:translateY(-1px);box-shadow:0 8px 18px rgba(15,23,42,.28)}
.pivot-copy-btn:focus-visible{outline:2px solid var(--accent);outline-offset:3px}
.pivot-copy-btn.is-copied{color:var(--ok);border-color:color-mix(in srgb,var(--ok) 60%, var(--border))}
.pivot-copy-btn.is-copied::after{content:"Copied!";position:absolute;top:calc(100% + 6px);right:0;border-radius:6px;border:1px solid var(--border);background:var(--panel);padding:4px 8px;color:var(--ok);font-size:11px;font-weight:700;white-space:nowrap;box-shadow:var(--shadow);pointer-events:none;z-index:5}
.pivot-card{margin:0;width:100%}
.pivot-card+.pivot-card{margin-top:0}
.pivot-card-head{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:8px}
.pivot-card-head .chart-title{margin-bottom:0}
.pivot-pagination{display:inline-flex;align-items:center;gap:8px}
.pivot-pagination.is-idle{opacity:.7}
.pivot-pagination[hidden]{display:none !important}
.pivot-nav-btn{width:30px;height:30px;min-width:30px;min-height:30px;display:grid;place-items:center;padding:0;border-radius:8px;font-size:16px;line-height:1}
.pivot-nav-btn:disabled{opacity:.45;cursor:not-allowed}
.pivot-nav-label{font-weight:700;color:var(--muted);font-size:12px;white-space:nowrap}
.pivot-body{margin-top:10px;overflow-y:auto;overflow-x:hidden;max-height:clamp(360px,55vh,520px);position:relative;border-radius:10px;background:var(--panel)}
.pivot-note{margin:2px 0 8px;color:var(--muted);font-size:12px;font-weight:600;line-height:1.35;}
.pivot-table{width:100%;border-collapse:collapse;min-width:320px;font-variant-numeric:tabular-nums}
.pivot-table thead th{padding:10px 12px;border-bottom:0;font-weight:700;color:var(--muted);font-size:12.5px;letter-spacing:.3px;text-transform:uppercase;position:sticky;top:0;background:var(--panel);z-index:3;text-align:right;box-shadow:inset 0 -2px 0 var(--border-strong)}
.pivot-table thead th.pivot-sortable{cursor:pointer;user-select:none}
.pivot-table thead th.pivot-sortable:focus-visible{outline:2px solid var(--accent);outline-offset:3px;border-radius:8px}
.pivot-sort-label{display:inline-flex;align-items:center;gap:6px;justify-content:flex-end}
.pivot-table thead th:first-child .pivot-sort-label{justify-content:flex-start}
.pivot-sort-indicator{font-size:10px;opacity:.75}
.pivot-table thead th:first-child{text-align:left}
.pivot-table thead th.pivot-acos{text-align:right}
.pivot-table thead th.pivot-acos-bar{padding-left:0;text-align:left;width:90px}
.pivot-table tbody th{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left;font-weight:600;color:var(--text);white-space:normal;word-break:break-word;overflow-wrap:anywhere}
.pivot-table tbody td{padding:10px 12px;border-bottom:1px solid var(--border);vertical-align:middle}
.pivot-table.has-grand-total tbody tr:last-child th,.pivot-table.has-grand-total tbody tr:last-child td{border-bottom:0}
.pivot-table tbody tr:hover{background:var(--chip)}
.pivot-table td.pivot-num{text-align:right;font-weight:600;font-variant-numeric:tabular-nums}
.pivot-table tfoot th,.pivot-table tfoot td{padding:12px;border:0;font-weight:800;background:var(--panel);position:sticky;bottom:0;z-index:2;border-top:3px double var(--border-strong);box-shadow:none}
.pivot-table tfoot th{text-align:left}
.pivot-table tfoot td{text-align:right}
.pivot-table tfoot td.pivot-acos{padding-right:12px}
.pivot-table tfoot td.pivot-acos-bar{text-align:left;padding-left:0}
.pivot-table tfoot td .pivot-amount-total{font-weight:800}
.pivot-table td.pivot-acos{color:var(--text);vertical-align:middle;text-align:right;white-space:nowrap}
.pivot-table td.pivot-acos .pivot-amount{display:inline-block;min-width:56px;text-align:right;font-weight:600}
.pivot-table td.pivot-acos.pivot-acos-empty{color:var(--muted)}
.pivot-table td.pivot-acos-bar{padding-left:0;padding-right:12px;vertical-align:middle}
.pivot-table td.pivot-acos-bar .pivot-bar{min-width:64px}
.pivot-table td.pivot-acos-bar.pivot-acos-empty{opacity:.4}
.pivot-bar-fill.acos{background:linear-gradient(90deg,rgba(239,68,68,.9),rgba(220,38,38,.95))}
.pivot-table tr.pivot-total th,.pivot-table tr.pivot-total td{font-weight:800}
.pivot-empty{text-align:center;padding:24px 12px;color:var(--muted);font-weight:600;letter-spacing:.2px}

.pivot-metric{display:flex;flex-direction:column;gap:6px}
.pivot-amount{font-weight:600;font-size:13.5px}
.pivot-amount-total{font-weight:800;font-size:14px}

.pivot-bar{position:relative;height:8px;border-radius:999px;background:var(--chip);overflow:hidden}
.pivot-bar-fill{position:absolute;inset:0;border-radius:inherit;opacity:.9}
.pivot-bar-fill.spend{background:linear-gradient(90deg,rgba(37,99,235,.95),rgba(30,64,175,.95))}
.pivot-bar-fill.sales{background:linear-gradient(90deg,rgba(16,185,129,.7),rgba(5,150,105,.85))}

/* Loader */
#statusArea{display:none}
#statusArea.show{position:fixed;inset:0;z-index:1000;display:grid;place-items:center;background:radial-gradient(900px 400px at 20% -10%, color-mix(in srgb, #ffffff 4%, var(--bg)) 0%, var(--bg) 45%)}
.loader{display:flex;align-items:center;gap:14px;padding:16px 18px;border:1px dashed var(--border);border-radius:14px;background:var(--chip);box-shadow:var(--shadow)}
.spinner{width:22px;height:22px;border-radius:50%;border:3px solid rgba(255,255,255,.25);border-top-color:var(--accent);animation:spin .9s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Modal (filters) */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:50}
.modal.open{display:flex}
.modal-card{width:min(1120px,94vw);max-height:86vh;background:var(--panel);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:18px;overflow:visible}
.modal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
.modal-card{position:relative}
.modal-card::before{content:"";position:absolute;inset:-1px;border-radius:inherit;padding:1px;background:linear-gradient(135deg,color-mix(in srgb,var(--accent) 35%, transparent) 0%,transparent 42%,color-mix(in srgb,var(--accent) 28%, transparent) 100%);-webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude;pointer-events:none}
.modal-head{padding-bottom:12px;margin-bottom:16px;border-bottom:1px solid var(--border-strong)}
.modal-head h3{margin:0;font-size:20px;font-weight:800;letter-spacing:.4px;text-transform:uppercase;color:var(--text)}
.filters{display:grid;gap:14px;grid-template-columns:repeat(12, minmax(0,1fr));overflow:visible;padding:12px;border:1px solid var(--border);border-radius:14px;background:color-mix(in srgb,var(--panel) 90%, var(--chip))}
.filter{display:grid;gap:6px;min-width:0;grid-column:span 4}
.filter.grow{grid-column:span 8}
.filter.search{grid-column:span 12}
.filter label{font-weight:700;color:var(--text);text-transform:uppercase;letter-spacing:.4px;font-size:12px}
.filter label::after{content:"";display:block;width:18px;height:2px;border-radius:999px;background:var(--accent);margin-top:4px}

/* Multi-select */
.dd{position:relative}
.dd-control{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:var(--panel);cursor:pointer;min-height:40px}
.dd-summary{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.dd-chev{opacity:.8}
.dd-panel{position:absolute;top:calc(100% + 8px);left:0;z-index:100;background:var(--panel);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);width:min(420px, 90vw);max-height:360px;display:none;overflow:auto}
.dd.open .dd-panel{display:block}
.dd-head{display:grid;grid-template-columns: 1fr 1.4fr 90px;gap:6px;align-items:center;padding:8px;border-bottom:1px solid var(--border);background:var(--chip);border-top-left-radius:12px;border-top-right-radius:12px}
.dd-head .select-all{display:flex;align-items:center;gap:8px;font-weight:700}
.dd-head input[type="search"]{width:100%;border:1px solid var(--border);border-radius:8px;padding:8px 10px;background:var(--panel);color:var(--text)}
.dd-head .rc{justify-self:end;color:var(--muted);font-weight:700}
.dd-list{overflow:auto;padding:6px}
.dd-item{display:grid;grid-template-columns:1fr auto 60px;gap:8px;align-items:center;padding:6px;border-radius:8px}
.dd-item:hover{background:var(--chip)}
.dd-left{display:flex;align-items:center;gap:8px;min-width:0}
.dd-text{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:30ch}
.dd-only{border:1px solid var(--border);background:var(--chip);color:var(--muted);border-radius:8px;padding:4px 8px;cursor:pointer}
.dd-count{text-align:right;color:var(--muted);font-variant-numeric:tabular-nums}
.dd-empty{padding:12px;text-align:center;color:var(--muted);font-weight:600;display:none}
.dd.no-results .dd-list{display:none}
.dd.no-results .dd-empty{display:block}

/* KPI sparklines */
.kpi{position:relative;overflow:hidden;transition:transform .18s ease, box-shadow .25s ease;padding-right:calc(10px + clamp(54px,45%,90px))}
.kpi:hover{transform:translateY(-3px);box-shadow:0 12px 28px rgba(15,23,42,.28)}
.kpi-spark{position:absolute;top:10px;right:10px;bottom:8px;width:clamp(54px,45%,90px);pointer-events:none;opacity:0;transition:opacity .25s ease}
.kpi:hover .kpi-spark{opacity:.9}
.kpi.small{padding-right:calc(8px + clamp(48px,48%,82px))}
.kpi.small .kpi-spark{right:8px;width:clamp(48px,48%,82px)}

/* Pivot animations */
.pivot-animate-forward{animation:pivotSlideLeft .4s ease}
.pivot-animate-backward{animation:pivotSlideRight .4s ease}
@keyframes pivotSlideRight{from{opacity:0;transform:translateX(-24px);}to{opacity:1;transform:translateX(0);}}
@keyframes pivotSlideLeft{from{opacity:0;transform:translateX(24px);}to{opacity:1;transform:translateX(0);}}

/* responsive */
@media (max-width:980px){.kpis{grid-template-columns:repeat(4,1fr)}}
@media (max-width:620px){.kpis{grid-template-columns:repeat(2,1fr)}}
</style>
</head>
<body>

<header id="appHeader" class="app-header">
  <div><h1>ðŸ”Ž Search Terms Analytics</h1></div>
  <div class="actions">
    <button id="resetFilters" class="btn-reset">Reset</button>
    <button id="openFilters" class="btn-filters" style="display:none">Filters</button>
    <button id="pickLocalBtn" class="btn-primary btn-success">Open XLSX</button>
    <input id="fileInput" type="file" accept=".xlsx,.xls" hidden />
    <button id="downloadCsvBtn" class="btn-primary btn-success" disabled>Download CSV</button>
    <button id="themeToggle" class="btn-mode" title="Toggle dark/light" aria-label="Toggle theme"><span class="icon">ðŸŒ™</span></button>
  </div>
</header>

<main id="contentWrap">
  <div id="emptyState" class="empty-state" role="status">
    ðŸ“„ No Excel detected. Click <span id="emptyOpenLink" role="button" tabindex="0">Open XLSX</span> to load a file.
  </div>

  <div class="topline" id="topLine">
    <div class="pill" id="tipPill" hidden>ðŸ“„ No Excel detected. Click <b>Open XLSX</b> to load a file.</div>
    <div class="topline-controls">
      <div class="pivot-tabs-bar" id="pivotTabsBar" hidden>
        <div id="pivotTabs" class="pivot-tabs" role="tablist" aria-label="Pivot views">
          <button type="button" class="pivot-tab is-active" data-tab="overview" role="tab" aria-selected="true">Overview Pivots</button>
          <button type="button" class="pivot-tab" data-tab="overall" role="tab" aria-selected="false" tabindex="-1">Overall Pivots</button>
          <button type="button" class="pivot-tab" data-tab="campaignPortfolio" role="tab" aria-selected="false" tabindex="-1">Campaign / Portfolio</button>
          <button type="button" class="pivot-tab" data-tab="conversion" role="tab" aria-selected="false" tabindex="-1">ST-ASIN Conversion</button>
        </div>
      </div>
      <div class="months-wrap" id="monthsWrap" hidden>
        <div id="monthFilter" class="month-dd">
          <div class="dd-control"><span class="dd-summary">All</span><span class="dd-chev">â–¾</span></div>
          <div class="dd-panel">
            <div id="monthList"></div>
            <div class="month-custom">
              <button type="button" id="customRangeToggle" class="month-custom-btn">Custom date rangeâ€¦</button>
              <div id="customRangePanel" class="month-range-panel" hidden>
                <div class="month-range-fields">
                  <label>
                    <span>From</span>
                    <input type="date" id="customRangeStart" />
                  </label>
                  <label>
                    <span>To</span>
                    <input type="date" id="customRangeEnd" />
                  </label>
                </div>
                <div class="month-range-actions">
                  <button type="button" id="customRangeApply" class="month-range-apply">Apply</button>
                  <button type="button" id="customRangeClear" class="month-range-clear">Clear</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <section class="status" id="statusArea" aria-live="polite">
    <div class="loader"><div class="spinner"></div><div><strong>Processing data</strong></div></div>
  </section>

  <!-- KPIs -->
  <section class="kpis" id="kpiSection" hidden>
  <div class="kpi" data-kpi="spend"><div class="label">Spend</div><div class="value" id="kpiSpend">â€”</div></div>
  <div class="kpi" data-kpi="revenue"><div class="label">Sales</div><div class="value" id="kpiRevenue">â€”</div></div>
  <div class="kpi small" data-kpi="acos"><div class="label">ACOS</div><div class="value" id="kpiACOS">â€”</div></div>
  <div class="kpi" data-kpi="clicks"><div class="label">Clicks</div><div class="value" id="kpiClicks">â€”</div></div>
  <div class="kpi" data-kpi="impressions"><div class="label">Impressions</div><div class="value" id="kpiImpr">â€”</div></div>
  <div class="kpi small" data-kpi="ctr"><div class="label">CTR</div><div class="value" id="kpiCTR">â€”</div></div>
  <div class="kpi" data-kpi="roas"><div class="label">ROAS</div><div class="value" id="kpiROAS">â€”</div></div>
  <div class="kpi" data-kpi="avgcpc"><div class="label">Avg CPC</div><div class="value" id="kpiAvgCPC">â€”</div></div>
</section>

  <!-- Pivot Table -->
  <section class="pivot" id="pivotSection" hidden>
  <div class="chart-card pivot-card pivot-overall-left" id="pivotStoreCard">
    <div class="chart-title">
      <span class="chart-title-text">Store Performance Pivot</span>
      <button type="button" class="pivot-copy-btn" data-copy-target="pivotTableStore" title="Copy Store Performance Pivot table" aria-label="Copy Store Performance Pivot table">
        <span class="pivot-copy-icon" aria-hidden="true">ðŸ“‹</span>
      </button>
    </div>
    <div class="pivot-body">
      <table id="pivotTableStore" class="pivot-table"></table>
    </div>
  </div>
  <div class="chart-card pivot-card pivot-overall-left" id="pivotLoCard">
    <div class="chart-title">
      <span class="chart-title-text">LO Performance Pivot</span>
      <button type="button" class="pivot-copy-btn" data-copy-target="pivotTableLo" title="Copy LO Performance Pivot table" aria-label="Copy LO Performance Pivot table">
        <span class="pivot-copy-icon" aria-hidden="true">ðŸ“‹</span>
      </button>
    </div>
    <div class="pivot-body">
      <table id="pivotTableLo" class="pivot-table"></table>
    </div>
  </div>
  <div class="chart-card pivot-card pivot-overall-left" id="pivotCustTypeCard">
    <div class="chart-title">
      <span class="chart-title-text">Customer Search Term - TYPE Performance Pivot</span>
      <button type="button" class="pivot-copy-btn" data-copy-target="pivotTableCustType" title="Copy Customer Search Term - TYPE Performance Pivot table" aria-label="Copy Customer Search Term - TYPE Performance Pivot table">
        <span class="pivot-copy-icon" aria-hidden="true">ðŸ“‹</span>
      </button>
    </div>
    <div class="pivot-body">
      <table id="pivotTableCustType" class="pivot-table"></table>
    </div>
  </div>
  <div class="chart-card pivot-card pivot-overall-right" id="pivotCatCard">
    <div class="chart-title">
      <span class="chart-title-text">Category Performance Pivot</span>
      <button type="button" class="pivot-copy-btn" data-copy-target="pivotTableCat" title="Copy Category Performance Pivot table" aria-label="Copy Category Performance Pivot table">
        <span class="pivot-copy-icon" aria-hidden="true">ðŸ“‹</span>
      </button>
    </div>
    <div class="pivot-body">
      <table id="pivotTableCat" class="pivot-table"></table>
    </div>
  </div>
  <div class="chart-card pivot-card pivot-overall-right" id="pivotPlacementCard">
    <div class="chart-title">
      <span class="chart-title-text">Placement Performance Pivot</span>
      <button type="button" class="pivot-copy-btn" data-copy-target="pivotTablePlacement" title="Copy Placement Performance Pivot table" aria-label="Copy Placement Performance Pivot table">
        <span class="pivot-copy-icon" aria-hidden="true">ðŸ“‹</span>
      </button>
    </div>
    <div class="pivot-body">
      <table id="pivotTablePlacement" class="pivot-table"></table>
    </div>
  </div>
  <div class="chart-card pivot-card" id="pivotCampaignCard">
    <div class="chart-title">
      <span class="chart-title-text">Campaign Performance Pivot</span>
      <button type="button" class="pivot-copy-btn" data-copy-target="pivotTableCampaign" title="Copy Campaign Performance Pivot table" aria-label="Copy Campaign Performance Pivot table">
        <span class="pivot-copy-icon" aria-hidden="true">ðŸ“‹</span>
      </button>
    </div>
    <div class="pivot-body">
      <table id="pivotTableCampaign" class="pivot-table"></table>
    </div>
  </div>
  <div class="chart-card pivot-card" id="pivotPortfolioCard">
    <div class="chart-title">
      <span class="chart-title-text">Portfolio Performance Pivot</span>
      <button type="button" class="pivot-copy-btn" data-copy-target="pivotTablePortfolio" title="Copy Portfolio Performance Pivot table" aria-label="Copy Portfolio Performance Pivot table">
        <span class="pivot-copy-icon" aria-hidden="true">ðŸ“‹</span>
      </button>
    </div>
    <div class="pivot-body">
      <table id="pivotTablePortfolio" class="pivot-table"></table>
    </div>
  </div>
  <div class="chart-card pivot-card pivot-conversion" id="pivotConversionStCard">
    <div class="chart-title">
      <span class="chart-title-text">Customer Search Term (ST) Performance Pivot</span>
      <button type="button" class="pivot-copy-btn" data-copy-target="pivotTableConversionSt" title="Copy Customer Search Term (ST) Performance Pivot table" aria-label="Copy Customer Search Term (ST) Performance Pivot table">
        <span class="pivot-copy-icon" aria-hidden="true">ðŸ“‹</span>
      </button>
    </div>
    <div class="pivot-body">
      <table id="pivotTableConversionSt" class="pivot-table"></table>
    </div>
  </div>
  <div class="chart-card pivot-card pivot-conversion" id="pivotConversionAsinCard">
    <div class="chart-title">
      <span class="chart-title-text">Customer Search Term (ASIN) Performance Pivot</span>
      <button type="button" class="pivot-copy-btn" data-copy-target="pivotTableConversionAsin" title="Copy Customer Search Term (ASIN) Performance Pivot table" aria-label="Copy Customer Search Term (ASIN) Performance Pivot table">
        <span class="pivot-copy-icon" aria-hidden="true">ðŸ“‹</span>
      </button>
    </div>
    <div class="pivot-body">
      <table id="pivotTableConversionAsin" class="pivot-table"></table>
    </div>
  </div>
</section>

</main>

<!-- Filters Modal -->
<div id="filtersModal" class="modal" aria-hidden="true" role="dialog" aria-label="Filters">
  <div class="modal-card">
    <div class="modal-head">
      <h3>Filters</h3>
      <button id="closeFilters" class="btn-outline" title="Close">âœ•</button>
    </div>

    <section class="filters" id="filtersSection" hidden>
      <div class="filter" data-col-wrapper="category"><label data-col-label="category" data-default="Category">Category</label><div id="categoryMS" class="dd"></div></div>
      <div class="filter" data-col-wrapper="store"><label data-col-label="store" data-default="Store">Store</label><div id="storeMS" class="dd"></div></div>
      <div class="filter" data-col-wrapper="lo"><label data-col-label="lo" data-default="LO">LO</label><div id="loMS" class="dd"></div></div>
      <div class="filter" data-col-wrapper="ttype"><label data-col-label="ttype" data-default="Targeting Type">Targeting Type</label><div id="ttypeMS" class="dd"></div></div>
      <div class="filter" data-col-wrapper="tsub"><label data-col-label="tsub" data-default="Targeting Sub Type">Targeting Sub Type</label><div id="tsubMS" class="dd"></div></div>
      <div class="filter" data-col-wrapper="tsub2"><label data-col-label="tsub2" data-default="Targeting Sub Type2">Targeting Sub Type2</label><div id="tsub2MS" class="dd"></div></div>
      <div class="filter grow" data-col-wrapper="campaign"><label data-col-label="campaign" data-default="Campaign Name">Campaign Name</label><div id="campaignMS" class="dd"></div></div>
      <div class="filter grow" data-col-wrapper="portfolio"><label data-col-label="portfolio" data-default="Portfolio Name">Portfolio Name</label><div id="portfolioMS" class="dd"></div></div>

      <div class="filter search"><label for="searchFilter">Search Term</label>
        <input id="searchFilter" type="search" placeholder="Type to filter termsâ€¦" style="flex:1;border:1px solid var(--border);border-radius:10px;padding:10px 12px;background:var(--panel);color:var(--text)">
      </div>
    </section>

    <div class="modal-actions">
      <button id="clearAll" class="btn-outline">Clear All</button>
      <button id="cancelFilters" class="btn-outline">Cancel</button>
      <button id="applyFilters" class="btn-primary">Apply</button>
    </div>
  </div>
</div>

<script>
'use strict';

function ensureConversionElements(){
  const tabsList=document.getElementById('pivotTabs');
  if(tabsList && !tabsList.querySelector('[data-tab="conversion"]')){
    const btn=document.createElement('button');
    btn.type='button';
    btn.className='pivot-tab';
    btn.dataset.tab='conversion';
    btn.setAttribute('role','tab');
    btn.setAttribute('aria-selected','false');
    btn.setAttribute('tabindex','-1');
    btn.textContent='ST-ASIN Conversion';
    tabsList.appendChild(btn);
  }

  const pivotSection=document.getElementById('pivotSection');
  if(!pivotSection) return;

  const createNav=(type)=>{
    const nav=document.createElement('div');
    nav.className='pivot-pagination';
    nav.dataset.pivot=type;
    const prev=document.createElement('button');
    prev.type='button';
    prev.className='pivot-nav-btn prev';
    prev.setAttribute('aria-label','Previous 500 rows');
    prev.textContent='â€¹';
    prev.disabled=true;
    const label=document.createElement('span');
    label.className='pivot-nav-label';
    label.textContent='â€”';
    const next=document.createElement('button');
    next.type='button';
    next.className='pivot-nav-btn next';
    next.setAttribute('aria-label','Next 500 rows');
    next.textContent='â€º';
    next.disabled=true;
    nav.append(prev,label,next);
    return nav;
  };

  const ensureHead=(card)=>{
    if(!card) return null;
    let head=card.querySelector('.pivot-card-head');
    if(head) return head;
    head=document.createElement('div');
    head.className='pivot-card-head';
    const titleNode=card.querySelector('.chart-title');
    if(titleNode){
      card.insertBefore(head,titleNode);
      head.appendChild(titleNode);
    }else{
      const title=document.createElement('div');
      title.className='chart-title';
      head.appendChild(title);
      card.insertBefore(head, card.firstChild||null);
    }
    return head;
  };

  const ensureCard=(cardId,title,tableId,type)=>{
    let card=document.getElementById(cardId);
    if(!card){
      card=document.createElement('div');
      card.id=cardId;
      card.className='chart-card pivot-card pivot-conversion';
      const head=document.createElement('div');
      head.className='pivot-card-head';
      const titleNode=document.createElement('div');
      titleNode.className='chart-title';
      titleNode.textContent=title;
      head.appendChild(titleNode);
      head.appendChild(createNav(type));
      card.appendChild(head);
      const body=document.createElement('div');
      body.className='pivot-body';
      const table=document.createElement('table');
      table.id=tableId;
      table.className='pivot-table';
      body.appendChild(table);
      card.appendChild(body);
      pivotSection.appendChild(card);
      return card;
    }

    const head=ensureHead(card);
    if(head && !head.querySelector('.pivot-pagination')){
      head.appendChild(createNav(type));
    }
    const titleNode=head?.querySelector('.chart-title') || card.querySelector('.chart-title');
    if(titleNode) titleNode.textContent=title;
    if(tableId && !card.querySelector(`#${tableId}`)){
      let body=card.querySelector('.pivot-body');
      if(!body){
        body=document.createElement('div');
        body.className='pivot-body';
        card.appendChild(body);
      }
      const table=document.createElement('table');
      table.id=tableId;
      table.className='pivot-table';
      body.appendChild(table);
    }

    return card;
  };

  ensureCard('pivotConversionStCard','Customer Search Term (ST) Performance Pivot','pivotTableConversionSt','st');
  ensureCard('pivotConversionAsinCard','Customer Search Term (ASIN) Performance Pivot','pivotTableConversionAsin','asin');
}

function createPivotCopyButton(tableId,label){
  const btn=document.createElement('button');
  btn.type='button';
  btn.className='pivot-copy-btn';
  if(tableId) btn.dataset.copyTarget=tableId;
  const labelText=label?`Copy ${label} table`:'Copy pivot table';
  btn.title=labelText;
  btn.setAttribute('aria-label', labelText);
  const icon=document.createElement('span');
  icon.className='pivot-copy-icon';
  icon.setAttribute('aria-hidden','true');
  icon.textContent='ðŸ“‹';
  btn.appendChild(icon);
  return btn;
}
ensureConversionElements();

/* ===== helpers ===== */
const fmt={
  int:n=>isFinite(n)?n.toLocaleString():"â€”",
  compact:n=>isFinite(n)?new Intl.NumberFormat(undefined,{notation:'compact',maximumFractionDigits:1}).format(n):"â€”",
  pct:r=>isFinite(r)?(r*100).toLocaleString(undefined,{maximumFractionDigits:2})+'%':"â€”",
  money:n=>isFinite(n)?n.toLocaleString(undefined,{style:"currency",currency:"USD"}):"â€”",
  money0:n=>isFinite(n)?n.toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:0,minimumFractionDigits:0}):"â€”",
  num0:n=>isFinite(n)?new Intl.NumberFormat(undefined,{maximumFractionDigits:0,minimumFractionDigits:0}).format(n):"â€”"
};
const MONTH_NAMES=["January","February","March","April","May","June","July","August","September","October","November","December"];
const normalize=s=>String(s||"").trim().toLowerCase().replace(/\s+/g," ");
const escapeHtml=s=>String(s).replace(/[&<>\"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const debounce=(fn,ms=150)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);};};
const toDMY=d=>!(d instanceof Date)?"":`${String(d.getDate()).padStart(2,'0')} ${MONTH_NAMES[d.getMonth()]||''} ${d.getFullYear()}`.trim();
const parseDMY=(s)=>{ if(!s) return null; const m=String(s).match(/^(\d{2})[-/](\d{2})[-/](\d{4})$/); if(!m) return null; const d=new Date(+m[3], +m[2]-1, +m[1]); return isNaN(+d)?null:d; };
const toInputDate=d=>!(d instanceof Date)?"":`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
const parseInputDate=s=>{ if(!s) return null; const m=String(s).match(/^(\d{4})-(\d{2})-(\d{2})$/); if(!m) return null; const d=new Date(+m[1], +m[2]-1, +m[3]); return isNaN(+d)?null:d; };
const cloneDate=d=> (d instanceof Date) ? new Date(d.getTime()) : null;
function parseNumber(v){ if(v==null || v==="") return 0; if(typeof v==='number' && isFinite(v)) return v; let s=String(v).trim(); if(/^\(.*\)$/.test(s)) s='-'+s.slice(1,-1); if(/%$/.test(s)){ const num=parseFloat(s.replace(/[%\s,]/g,'')); return isFinite(num)?num/100:0; } s=s.replace(/[$â‚¬Â£â‚¹Â¥â‚©]/g,'').replace(/,/g,'').replace(/[^\d.\-]/g,'').trim(); const num=parseFloat(s); return isFinite(num)?num:0; }
function clampPanelRight(panel){ panel.style.left='0'; panel.style.right='auto'; const rect=panel.getBoundingClientRect(), vw=document.documentElement.clientWidth; if(rect.right>vw-10){ panel.style.left='auto'; panel.style.right='0'; }}

function hideCustomRangePanel(){
  if(el.monthCustomPanel){
    el.monthCustomPanel.setAttribute('hidden','');
  }
  if(el.monthCustomToggle){
    el.monthCustomToggle.setAttribute('aria-expanded','false');
  }
}
function showCustomRangePanel(){
  if(!el.monthCustomPanel) return;
  syncCustomRangeInputs();
  el.monthCustomPanel.removeAttribute('hidden');
  if(el.monthCustomToggle){
    el.monthCustomToggle.setAttribute('aria-expanded','true');
  }
}
function syncCustomRangeInputs(){
  if(!el.monthCustomStart || !el.monthCustomEnd) return;
  const {min,max}=state.dateBounds || {};
  const minStr=toInputDate(min);
  const maxStr=toInputDate(max);
  if(minStr){
    el.monthCustomStart.min=minStr; el.monthCustomEnd.min=minStr;
  }else{
    el.monthCustomStart.removeAttribute('min'); el.monthCustomEnd.removeAttribute('min');
  }
  if(maxStr){
    el.monthCustomStart.max=maxStr; el.monthCustomEnd.max=maxStr;
  }else{
    el.monthCustomStart.removeAttribute('max'); el.monthCustomEnd.removeAttribute('max');
  }
  const startValue=state.customRange.start || min || null;
  const endValue=state.customRange.end || max || null;
  el.monthCustomStart.value=toInputDate(startValue);
  el.monthCustomEnd.value=toInputDate(endValue);
}
function applyCustomRangeFromInputs(){
  if(!state.hasData) return;
  const start=parseInputDate(el.monthCustomStart?.value||'');
  const end=parseInputDate(el.monthCustomEnd?.value||'');
  if(!start || !end){
    alert('Please select both start and end dates.');
    return;
  }
  if(start>end){
    alert('Start date must be on or before end date.');
    return;
  }
  start.setHours(0,0,0,0);
  end.setHours(0,0,0,0);
  state.customRange={start,end,active:true};
  state.monthSel.clear();
  state.monthDirty=false;
  el.monthList?.querySelectorAll('input[type=checkbox]').forEach(cb=>cb.checked=false);
  if(el.monthDD) el.monthDD.classList.remove('open');
  syncCustomRangeInputs();
  hideCustomRangePanel();
  updateMonthSummary();
  if(state.hasData){
    updateAllFilterOptions(null);
    resetConversionPaging();
    renderAll();
  }
  updateResetButtonVisibility();
}
function clearCustomRange(options={}){
  const {skipRender=false, skipFilters=false}=options;
  const hadActive = state.customRange.active || state.customRange.start || state.customRange.end;
  state.customRange={start:null,end:null,active:false};
  if(el.monthCustomStart) el.monthCustomStart.value='';
  if(el.monthCustomEnd) el.monthCustomEnd.value='';
  hideCustomRangePanel();
  updateMonthSummary();
  updateResetButtonVisibility();
  if(!hadActive) return;
  resetConversionPaging();
  if(state.hasData && !skipFilters) updateAllFilterOptions(null);
  if(state.hasData && !skipRender) renderAll();
}
function deactivateCustomRange(){
  if(!state.customRange.active) return;
  state.customRange.active=false;
  updateMonthSummary();
  updateResetButtonVisibility();
}

/* ===== elements/state ===== */
const el={header:document.getElementById('appHeader'),topLine:document.getElementById('topLine'),tipPill:document.getElementById('tipPill'),monthsWrap:document.getElementById('monthsWrap'),monthDD:document.getElementById('monthFilter'),monthList:document.getElementById('monthList'),monthCustomToggle:document.getElementById('customRangeToggle'),monthCustomPanel:document.getElementById('customRangePanel'),monthCustomStart:document.getElementById('customRangeStart'),monthCustomEnd:document.getElementById('customRangeEnd'),monthCustomApply:document.getElementById('customRangeApply'),monthCustomClear:document.getElementById('customRangeClear'),tabs:{bar:document.getElementById('pivotTabsBar'),list:document.getElementById('pivotTabs')},status:document.getElementById('statusArea'),kpis:document.getElementById('kpiSection'),pivot:{section:document.getElementById('pivotSection'),store:{card:document.getElementById('pivotStoreCard'),table:document.getElementById('pivotTableStore')},lo:{card:document.getElementById('pivotLoCard'),table:document.getElementById('pivotTableLo')},cat:{card:document.getElementById('pivotCatCard'),table:document.getElementById('pivotTableCat')},custType:{card:document.getElementById('pivotCustTypeCard'),table:document.getElementById('pivotTableCustType')},placement:{card:document.getElementById('pivotPlacementCard'),table:document.getElementById('pivotTablePlacement')},campaign:{card:document.getElementById('pivotCampaignCard'),table:document.getElementById('pivotTableCampaign')},portfolio:{card:document.getElementById('pivotPortfolioCard'),table:document.getElementById('pivotTablePortfolio')},conversionSt:{card:document.getElementById('pivotConversionStCard'),table:document.getElementById('pivotTableConversionSt'),nav:document.querySelector('#pivotConversionStCard .pivot-pagination'),navPrev:document.querySelector('#pivotConversionStCard .pivot-nav-btn.prev'),navNext:document.querySelector('#pivotConversionStCard .pivot-nav-btn.next'),navLabel:document.querySelector('#pivotConversionStCard .pivot-nav-label')},conversionAsin:{card:document.getElementById('pivotConversionAsinCard'),table:document.getElementById('pivotTableConversionAsin'),nav:document.querySelector('#pivotConversionAsinCard .pivot-pagination'),navPrev:document.querySelector('#pivotConversionAsinCard .pivot-nav-btn.prev'),navNext:document.querySelector('#pivotConversionAsinCard .pivot-nav-btn.next'),navLabel:document.querySelector('#pivotConversionAsinCard .pivot-nav-label')}},pickLocalBtn:document.getElementById('pickLocalBtn'),fileInput:document.getElementById('fileInput'),dlCsv:document.getElementById('downloadCsvBtn'),openFiltersBtn:document.getElementById('openFilters'),resetFiltersBtn:document.getElementById('resetFilters'),modal:document.getElementById('filtersModal'),closeFiltersBtn:document.getElementById('closeFilters'),cancelFiltersBtn:document.getElementById('cancelFilters'),applyFiltersBtn:document.getElementById('applyFilters'),clearAllBtn:document.getElementById('clearAll'),filters:document.getElementById('filtersSection'),themeBtn:document.getElementById('themeToggle'),empty:document.getElementById('emptyState'),emptyOpen:document.getElementById('emptyOpenLink'),kpi:{spend:document.getElementById('kpiSpend'),revenue:document.getElementById('kpiRevenue'),acos:document.getElementById('kpiACOS'),clicks:document.getElementById('kpiClicks'),impr:document.getElementById('kpiImpr'),ctr:document.getElementById('kpiCTR'),roas:document.getElementById('kpiROAS'),avgcpc:document.getElementById('kpiAvgCPC')},dd:{category:document.getElementById('categoryMS'),store:document.getElementById('storeMS'),lo:document.getElementById('loMS'),ttype:document.getElementById('ttypeMS'),tsub:document.getElementById('tsubMS'),tsub2:document.getElementById('tsub2MS'),campaign:document.getElementById('campaignMS'),portfolio:document.getElementById('portfolioMS')},search:document.getElementById('searchFilter')};
const state={ rows:[], columns:{}, monthSel:new Set(), monthOptions:[], monthDirty:false, snapshot:{}, hasData:false, activeTab:'overview', customRange:{start:null,end:null,active:false}, dateBounds:{min:null,max:null}, conversionPage:{st:0,asin:0}, lastTabIndex:0 };
const TAB_ORDER=['overview','overall','campaignPortfolio','conversion'];
const PIVOT_SORT_KEYS=new Set(['label','spend','sales','acos']);

const kpiSparkCache=new Map();
const copyFeedbackTimers=new WeakMap();
const PIVOT_LABEL_COLLATOR=new Intl.Collator(undefined,{sensitivity:'base'});
let lastKpiSeries=null;
let pivotLayoutFrame=null;
if(el.tabs?.list){ el.tabs.buttons = Array.from(el.tabs.list.querySelectorAll('[data-tab]')); }
const PIVOT_CONFIG={
  overview:[
    {slot:'store', column:'store', fallback:'Store'},
    {slot:'lo', column:'lo', fallback:'LO'},
    {slot:'cat', column:'category', fallback:'Category'}
  ],
  overall:[
    {slot:'store', column:'ttype', fallback:'Targeting Type'},
    {slot:'lo', column:'tsub', fallback:'Targeting Sub Type'},
    {slot:'custType', column:'customerType', fallback:'Customer Search Term - TYPE'},
    {slot:'cat', column:'tsub2', fallback:'Targeting Sub Type2'},
    {slot:'placement', column:'placement', fallback:'Placement'}
  ],
  campaignPortfolio:[
    {slot:'campaign', column:'campaign', fallback:'Campaign Name'},
    {slot:'portfolio', column:'portfolio', fallback:'Portfolio Name'}
  ],
  conversion:[]
};
const DEFAULT_WORKBOOK='Products Search Term.xlsx';


function resetConversionPaging(){
  state.conversionPage={st:0,asin:0};
}

function initConversionNav(){
  const attach=(target,slot)=>{
    if(!target?.card) return;
    if(!target.nav){
      target.nav=target.card.querySelector('.pivot-pagination');
    }
    if(!target.nav) return;
    if(!target.navLabel) target.navLabel=target.nav.querySelector('.pivot-nav-label');
    if(!target.navPrev) target.navPrev=target.nav.querySelector('.pivot-nav-btn.prev');
    if(!target.navNext) target.navNext=target.nav.querySelector('.pivot-nav-btn.next');
    const key=slot==='conversionAsin'?'asin':'st';
    if(target.navPrev && !target.navPrev.__bound){
      target.navPrev.__bound=true;
      target.navPrev.addEventListener('click',()=>goToConversionPage(key,-1));
    }
    if(target.navNext && !target.navNext.__bound){
      target.navNext.__bound=true;
      target.navNext.addEventListener('click',()=>goToConversionPage(key,1));
    }
  };
  attach(el.pivot?.conversionSt,'conversionSt');
  attach(el.pivot?.conversionAsin,'conversionAsin');
}

function goToConversionPage(which, delta){
  if(!state.conversionPage) state.conversionPage={st:0,asin:0};
  const key=which==='asin'?'asin':'st';
  const current=state.conversionPage[key]||0;
  const next=Math.max(0, current+delta);
  if(next===current) return;
  state.conversionPage[key]=next;
  renderAll();
}

function updateConversionNav(target, agg){
  if(!target) return;
  if(!target.nav && target.card){
    target.nav=target.card.querySelector('.pivot-pagination');
    if(target.nav){
      target.navLabel=target.nav.querySelector('.pivot-nav-label');
      target.navPrev=target.nav.querySelector('.pivot-nav-btn.prev');
      target.navNext=target.nav.querySelector('.pivot-nav-btn.next');
    }
  }
  if(!target.nav) return;
  const page=agg?.page;
  const total=Number.isFinite(agg?.total)?agg.total:0;
  const count=Array.isArray(agg?.labels)?agg.labels.length:0;
  if(target.navLabel){
    if(total && count){
      const start=Number.isFinite(page?.start)?page.start:0;
      const from=Math.min(total,start+1);
      const to=Math.min(total,start+count);
      target.navLabel.textContent=`${from.toLocaleString()}â€“${to.toLocaleString()} of ${total.toLocaleString()}`;
    }else if(total){
      target.navLabel.textContent=`0 of ${total.toLocaleString()}`;
    }else{
      target.navLabel.textContent='No rows';
    }
  }
  if(target.navPrev) target.navPrev.disabled=!(page && page.hasPrev);
  if(target.navNext) target.navNext.disabled=!(page && page.hasNext);
  target.nav.hidden = total<=0;
  const idle=!(page && (page.hasPrev || page.hasNext));
  target.nav.classList.toggle('is-idle', idle);
}


/* ===== theme + boot ===== */
document.addEventListener('DOMContentLoaded', () => {
  const saved=localStorage.getItem('theme')||'dark';
  if(saved==='light') document.body.classList.add('light');
  updateThemeBtn();
  el.themeBtn.addEventListener('click',()=>{
    document.body.classList.toggle('light');
    localStorage.setItem('theme', document.body.classList.contains('light')?'light':'dark');
    updateThemeBtn(); renderAll();
  });
  function updateThemeBtn(){
    const light=document.body.classList.contains('light');
    el.themeBtn.querySelector('.icon').textContent= light?'ðŸŒ™':'â˜€ï¸';
  }
  boot();
  window.addEventListener('resize', debounce(()=>{
    schedulePivotLayout();
    if(lastKpiSeries) updateKpiSparks(lastKpiSeries);
  },180));
});

function setupTabs(){
  if(!el.tabs?.buttons?.length) return;
  state.lastTabIndex = TAB_ORDER.indexOf(state.activeTab);
  el.tabs.buttons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const tab=btn.dataset.tab;
      if(!tab || state.activeTab===tab) return;
      const prevIndex = TAB_ORDER.indexOf(state.activeTab);
      const newIndex = TAB_ORDER.indexOf(tab);
      state.activeTab=tab;
      if(prevIndex>-1 && newIndex>-1 && prevIndex!==newIndex){
        animatePivot(newIndex>prevIndex?'forward':'backward');
      }
      state.lastTabIndex=newIndex;
      updateTabsUI();
      renderAll();
    });
  });
  updateTabsUI();
}
function updateTabsUI(){
  const buttons=el.tabs?.buttons||[];
  const active=state.activeTab||'overview';
  buttons.forEach(btn=>{
    const tab=btn.dataset.tab;
    const on=tab===active;
    btn.classList.toggle('is-active', on);
    btn.setAttribute('aria-selected', on?'true':'false');
    btn.setAttribute('tabindex', on?'0':'-1');
  });
}
function animatePivot(direction){
  const target=el.pivot?.section;
  if(!target) return;
  target.classList.remove('pivot-animate-forward','pivot-animate-backward');
  void target.offsetWidth;
  const cls = direction==='backward'?'pivot-animate-backward':'pivot-animate-forward';
  target.classList.add(cls);
  const handler=()=>{
    target.classList.remove('pivot-animate-forward','pivot-animate-backward');
    target.removeEventListener('animationend', handler);
  };
  target.addEventListener('animationend', handler);
}

function setupPivotInteractions(){
  const root=el.pivot?.section;
  if(!root) return;
  root.addEventListener('click', handlePivotSectionClick);
  root.addEventListener('keydown', handlePivotHeaderKeydown);
}

function handlePivotSectionClick(event){
  const copyBtn=event.target.closest?.('.pivot-copy-btn');
  if(copyBtn){
    event.preventDefault();
    handlePivotCopy(copyBtn);
    return;
  }
  const header=event.target.closest?.('th[data-sort-key]');
  if(header){
    event.preventDefault();
    togglePivotSort(header);
  }
}

function handlePivotHeaderKeydown(event){
  const header=event.target.closest?.('th[data-sort-key]');
  if(!header) return;
  if(event.key==='Enter' || event.key===' ' || event.key==='Spacebar'){
    event.preventDefault();
    togglePivotSort(header);
  }
}

function togglePivotSort(header){
  if(!header) return;
  const table=header.closest('table.pivot-table');
  if(!table || !table._pivotData) return;
  const key=header.dataset.sortKey;
  if(!PIVOT_SORT_KEYS.has(key)) return;
  const sort=table._pivotSort || (table._pivotSort={key:null,dir:'desc'});
  if(sort.key===key){
    sort.dir = sort.dir==='desc' ? 'asc' : 'desc';
  }else{
    sort.key = key;
    sort.dir = key==='label' ? 'asc' : 'desc';
  }
  renderPivotTable(table);
}

async function handlePivotCopy(button){
  if(!button) return;
  const tableId=button.dataset.copyTarget;
  let table=null;
  if(tableId) table=document.getElementById(tableId);
  if(!table){
    table=button.closest('.pivot-card')?.querySelector('table');
  }
  if(!table){
    console.warn('Pivot copy: target table not found');
    return;
  }
  const text=pivotTableToClipboardText(table);
  if(!text){
    console.warn('Pivot copy: no content to copy');
    return;
  }
  try{
    await copyTextToClipboard(text);
    showPivotCopySuccess(button);
  }catch(err){
    console.error('Failed to copy pivot table', err);
    alert('Unable to copy table to clipboard. Please copy manually.');
  }
}

function pivotTableToClipboardText(table){
  if(!table) return '';
  const rows=[];
  ['thead','tbody','tfoot'].forEach(sectionName=>{
    const section=table.querySelector(sectionName);
    if(!section) return;
    section.querySelectorAll('tr').forEach(tr=>{
      const cells=Array.from(tr.children||[])
        .filter(cell=>!cell.classList?.contains('pivot-acos-bar') && cell.getAttribute?.('aria-hidden')!=='true')
        .map(cell=>String(cell.textContent||'').replace(/\s+/g,' ').trim());
      if(cells.length) rows.push(cells.join('\t'));
    });
  });
  return rows.join('\n').trim();
}

async function copyTextToClipboard(text){
  if(!text) return;
  if(navigator.clipboard?.writeText){
    await navigator.clipboard.writeText(text);
    return;
  }
  const textarea=document.createElement('textarea');
  textarea.value=text;
  textarea.setAttribute('readonly','');
  textarea.style.position='fixed';
  textarea.style.opacity='0';
  textarea.style.pointerEvents='none';
  document.body.appendChild(textarea);
  textarea.focus();
  textarea.select();
  try{
    const ok=document.execCommand('copy');
    if(!ok) throw new Error('Copy command was rejected');
  }finally{
    document.body.removeChild(textarea);
  }
}

function showPivotCopySuccess(button){
  if(!button) return;
  button.classList.add('is-copied');
  const timer=copyFeedbackTimers.get(button);
  if(timer) clearTimeout(timer);
  const timeout=setTimeout(()=>{
    button.classList.remove('is-copied');
    copyFeedbackTimers.delete(button);
  },1600);
  copyFeedbackTimers.set(button, timeout);
}
function getPivotConfig(){ return PIVOT_CONFIG[state.activeTab] || PIVOT_CONFIG.overview; }

function boot(){
  setHasData(false);
  setupTabs();
  initConversionNav();
  const triggerPicker=()=>{ if(el.fileInput) el.fileInput.click(); };
  if(el.pickLocalBtn) el.pickLocalBtn.addEventListener('click', triggerPicker);
  if(el.emptyOpen){
    const openFromEmpty=(ev)=>{
      if(ev){
        if(ev.type==='keydown' && !['Enter',' ','Spacebar'].includes(ev.key)) return;
        if(ev.type==='keydown') ev.preventDefault();
      }
      triggerPicker();
    };
    el.emptyOpen.addEventListener('click', openFromEmpty);
    el.emptyOpen.addEventListener('keydown', openFromEmpty);
  }
  if(el.fileInput) el.fileInput.addEventListener('change', handleLocalFile);
  if(el.dlCsv) el.dlCsv.addEventListener('click', onDownloadCsv);
  el.openFiltersBtn.addEventListener('click', openFiltersModal);
  el.closeFiltersBtn.addEventListener('click', closeFiltersCancel);
  el.cancelFiltersBtn.addEventListener('click', closeFiltersCancel);
  el.applyFiltersBtn.addEventListener('click', closeFiltersApply);
  el.clearAllBtn.addEventListener('click', clearAllFilters);
  if(el.resetFiltersBtn) el.resetFiltersBtn.addEventListener('click', resetFiltersAndApply);
  const monthControl=el.monthDD.querySelector('.dd-control');
  monthControl.addEventListener('click', ()=>{
    const wasOpen=el.monthDD.classList.contains('open');
    el.monthDD.classList.toggle('open');
    if(!wasOpen){
      clampPanelRight(el.monthDD.querySelector('.dd-panel'));
    }else{
      applyMonthFilters();
    }
  });
  if(el.monthCustomToggle){
    el.monthCustomToggle.setAttribute('aria-expanded','false');
    el.monthCustomToggle.addEventListener('click', (ev)=>{
      ev.stopPropagation();
      const hidden=el.monthCustomPanel?.hasAttribute('hidden');
      if(hidden) showCustomRangePanel(); else hideCustomRangePanel();
    });
  }
  if(el.monthCustomPanel){
    el.monthCustomPanel.addEventListener('click', ev=>ev.stopPropagation());
  }
  if(el.monthCustomApply) el.monthCustomApply.addEventListener('click', applyCustomRangeFromInputs);
  if(el.monthCustomClear) el.monthCustomClear.addEventListener('click', ()=>clearCustomRange());

  document.addEventListener('click', (e)=>{
    const monthRoot=el.monthDD;
    const clickedMonth=e.target.closest('.month-dd');
    if(monthRoot && !clickedMonth && monthRoot.classList.contains('open')){
      monthRoot.classList.remove('open');
      applyMonthFilters();
    }
    const dd=e.target.closest('.dd'); document.querySelectorAll('.dd.open').forEach(d=>{ if(d!==dd) d.classList.remove('open');});
  });

  setupPivotInteractions();

  showLoading(false);
  el.tipPill.hidden=true;
  el.monthsWrap.hidden=true;
  attemptDefaultWorkbook();
}
function showLoading(on){ el.status.classList.toggle('show', !!on); el.status.style.display=on?'':'none'; }

function resetKpis(){ Object.values(el.kpi||{}).forEach(node=>{ if(node) node.textContent='â€”'; }); lastKpiSeries=null; updateKpiSparks(null); }

function setHasData(has){
  state.hasData=!!has;
  document.body.classList.toggle('has-data', !!has);
  if(has){
    if(el.topLine) el.topLine.style.display='flex';
    if(el.kpis) el.kpis.hidden=false;
    if(el.pivot?.section) el.pivot.section.hidden=false;
    if(el.openFiltersBtn) el.openFiltersBtn.style.display='inline-flex';
    if(el.dlCsv) el.dlCsv.disabled=false;
    if(el.monthsWrap) el.monthsWrap.hidden = state.monthOptions.length===0;
    if(el.monthCustomToggle) el.monthCustomToggle.disabled = state.monthOptions.length===0;
    if(el.tabs?.bar) el.tabs.bar.hidden=false;
    if(el.tipPill) el.tipPill.hidden=true;
    if(lastKpiSeries){
      const redraw=()=>updateKpiSparks(lastKpiSeries);
      if(typeof requestAnimationFrame==='function'){ requestAnimationFrame(redraw); }
      else redraw();
    }
  }else{
    if(el.topLine) el.topLine.style.display='none';
    if(el.kpis) el.kpis.hidden=true;
    if(el.pivot?.section) el.pivot.section.hidden=true;
    if(el.openFiltersBtn) el.openFiltersBtn.style.display='none';
    if(el.dlCsv) el.dlCsv.disabled=true;
    if(el.monthsWrap) el.monthsWrap.hidden=true;
    if(el.monthCustomToggle) el.monthCustomToggle.disabled=true;
    if(el.tabs?.bar) el.tabs.bar.hidden=true;
    if(el.tipPill) el.tipPill.hidden=false;
    state.columns={};
    state.rows=[];
    state.monthSel.clear();
    state.monthOptions=[];
    state.monthDirty=false;
    state.customRange={start:null,end:null,active:false};
    state.dateBounds={min:null,max:null};
    resetConversionPaging();
    if(el.monthList) el.monthList.innerHTML='';
    syncFilterLabels();
    state.activeTab='overview';
    state.lastTabIndex=TAB_ORDER.indexOf('overview');
    resetKpis();
    hideCustomRangePanel();
    syncCustomRangeInputs();
  }
  updateMonthSummary();
  updateTabsUI();
  updateResetButtonVisibility();
}

/* ===== Excel parsing (headers row 2, data from row 3) ===== */
function findIndexByTokens(headers, tokens){
  const HX=headers.map(h=>String(h||'').toLowerCase().replace(/[^a-z0-9]+/g,''));
  for(const t of tokens){ const i=HX.indexOf(t); if(i>-1) return i; }
  for(let i=0;i<HX.length;i++){ const h=HX[i]; if(tokens.some(t=>h.includes(t))) return i; }
  return -1;
}
async function handleLocalFile(e){
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  try{
    showLoading(true);
    const buf = await f.arrayBuffer();
    await loadWorkbookBuffer(buf);
  }catch(err){
    console.error(err);
    alert('Failed to parse Excel: '+(err?.message||err));
    if(!state.hasData) setHasData(false);
  }finally{
    showLoading(false);
    e.target.value='';
  }
}
async function loadWorkbookBuffer(buf){
  await parseExcel(buf);
  setHasData(true);
}
async function attemptDefaultWorkbook(){
  const file=DEFAULT_WORKBOOK && DEFAULT_WORKBOOK.trim();
  if(!file || state.hasData) return;
  try{
    showLoading(true);
    let targetUrl;
    try{
      targetUrl=new URL(file, document.baseURI).href;
    }catch(_){
      targetUrl=encodeURI(file);
    }
    const response=await fetch(targetUrl,{cache:'no-store'});
    if(!response.ok && response.status!==0) throw new Error('Default workbook not found');
    if(state.hasData) return;
    const buf=await response.arrayBuffer();
    if(state.hasData) return;
    await loadWorkbookBuffer(buf);
  }catch(err){
    console.warn('Default workbook could not be loaded:', err);
    if(!state.hasData) setHasData(false);
  }finally{
    showLoading(false);
  }
}
async function parseExcel(buf){
  const wb = XLSX.read(buf, { type:'array', cellDates:true, cellNF:true, cellText:false });
  let best=null,score=-1;
  for(const name of wb.SheetNames){
    const ws=wb.Sheets[name];
    const text=XLSX.utils.sheet_to_json(ws,{header:1,raw:false,defval:""});
    if(!text || text.length<3) continue;
    const headers=(text[1]||[]).map(x=>String(x||"").trim());
    const s=['store','sales','spend','clicks','impressions'].map(t=>findIndexByTokens(headers,[t])>-1?1:0).reduce((a,b)=>a+b,0);
    if(s>score){score=s;best=name;}
  }
  if(!best) throw new Error('No usable sheet found');
  const ws=wb.Sheets[best];
  const raw = XLSX.utils.sheet_to_json(ws,{header:1,raw:true,defval:""});
  const txt  = XLSX.utils.sheet_to_json(ws,{header:1,raw:false,defval:""});
  const headers=(txt[1]||raw[1]||[]).map(h=>String(h||"").trim());
  const dataR=raw.slice(2); const dataT=txt.slice(2);

  const cols={
    date:       findIndexByTokens(headers,['date','day','reportingdate']),
    store:      findIndexByTokens(headers,['store','lo','market','site','locale','country','account']),
    lo:         findIndexByTokens(headers,['lo','lineofbusiness','lob','store','market']),
    impressions:findIndexByTokens(headers,['impressions','impr']),
    clicks:     findIndexByTokens(headers,['clicks']),
    revenue:    findIndexByTokens(headers,['sales','revenue','totalsales','orderedrevenue','attributedsales']),
    spend:      findIndexByTokens(headers,['spend','adspend','cost','advertisingcost']),
    category:   findIndexByTokens(headers,['category','producttype','cat']),
    ttype:      findIndexByTokens(headers,['targetingtype','adtype','type']),
    tsub:       findIndexByTokens(headers,['targetingsubtype','matchtype','subtype']),
    tsub2:      findIndexByTokens(headers,['subtype2','matchtype2']),
    term:       findIndexByTokens(headers,['customersearchterm','searchterm','term']),
    customerType:findIndexByTokens(headers,['customersearchtermtype','searchtermtype']),
    placement:  findIndexByTokens(headers,['placement','placements']),
    campaign:   findIndexByTokens(headers,['campaignname','campaign']),
    portfolio:  findIndexByTokens(headers,['portfolioname','portfolio']),
  };
  const mapCols={}; for(const [k,idx] of Object.entries(cols)){ if(idx>-1) mapCols[k]={name:headers[idx],idx}; }
  if(mapCols.store && !mapCols.lo) mapCols.lo = {...mapCols.store, aliasOf:'store'}; // fallback
  state.columns=mapCols;

  const rows=[];
  for(let r=0;r<dataR.length;r++){
    const rr=dataR[r]||[], tt=dataT[r]||[];
    const o={};
    headers.forEach((h,i)=>{
      const key=normalize(h);
      let v=tt[i];
      if(mapCols.date && i===mapCols.date.idx){
        if(typeof rr[i]==='number'){ const d=XLSX.SSF.parse_date_code(rr[i]); v=(d&&d.y)?new Date(d.y,d.m-1,d.d):null; }
        else if(v){ const d=new Date(v); v=isNaN(+d)?null:d; }
        else v=null;
      }else if([mapCols.impressions?.idx,mapCols.clicks?.idx,mapCols.revenue?.idx,mapCols.spend?.idx].includes(i)){
        v=parseNumber(v);
      }
      o[key]=v;
    });
    if(Object.values(o).some(val => (val!=='' && val!=null))) rows.push(o);
  }
  state.rows=rows;
  state.monthSel.clear();
  resetConversionPaging();
  buildMonths(); initFilters(); renderAll();
}

/* ===== months & filters ===== */
function buildMonths(){
  state.monthDirty=false;
  const dateCol = state.columns.date ? normalize(state.columns.date.name) : null;
  if(!dateCol){
    state.monthOptions=[];
    state.dateBounds={min:null,max:null};
    clearCustomRange({skipRender:true, skipFilters:true});
    el.monthsWrap.hidden=true;
    if(el.monthCustomToggle) el.monthCustomToggle.disabled=true;
    syncCustomRangeInputs();
    updateMonthSummary();
    return;
  }
  const map=new Map();
  let minDate=null, maxDate=null;
  for(const r of state.rows){
    const d=r[dateCol]; if(!(d instanceof Date)) continue;
    if(!minDate || d<minDate) minDate=new Date(d.getFullYear(),d.getMonth(),d.getDate());
    if(!maxDate || d>maxDate) maxDate=new Date(d.getFullYear(),d.getMonth(),d.getDate());
    const ym=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    map.set(ym,(map.get(ym)||0)+1);
  }
  const arr=[...map.entries()].sort((a,b)=>a[0].localeCompare(b[0]));
  state.monthOptions=arr.map(([ym])=>{
    const monthIndex=+ym.slice(5)-1;
    return {ym,label:MONTH_NAMES[monthIndex]||ym};
  });
  state.dateBounds={min:minDate,max:maxDate};
  el.monthList.innerHTML=state.monthOptions.map(o=>`
    <label class="month-row">
      <input type="checkbox" value="${o.ym}" ${state.monthSel.has(o.ym)?'checked':''}/>
      <span class="month-name">${escapeHtml(o.label)}</span>
    </label>`).join('');
  el.monthList.querySelectorAll('input[type=checkbox]').forEach(cb=>{
    cb.addEventListener('change', ()=>{
      if(cb.checked) state.monthSel.add(cb.value);
      else state.monthSel.delete(cb.value);
      state.monthDirty=true;
      if(state.customRange.active) deactivateCustomRange();
      updateMonthSummary();
      updateResetButtonVisibility();
    });
  });
  if(el.monthCustomToggle) el.monthCustomToggle.disabled = state.monthOptions.length===0;
  syncCustomRangeInputs();
  updateMonthSummary();
  el.monthsWrap.hidden=state.monthOptions.length===0;
}
function updateMonthSummary(){
  const sumEl=el.monthDD.querySelector('.dd-summary');
  if(!sumEl) return;
  if(state.customRange.active){
    const {start,end}=state.customRange;
    if(start && end) sumEl.textContent=`${toDMY(start)} â€“ ${toDMY(end)}`;
    else if(start) sumEl.textContent=`From ${toDMY(start)}`;
    else if(end) sumEl.textContent=`Until ${toDMY(end)}`;
    else sumEl.textContent='Custom range';
    return;
  }
  const n=state.monthSel.size;
  if(n===0){ sumEl.textContent='All'; }
  else if(n===1){ const k=[...state.monthSel][0]; sumEl.textContent=(state.monthOptions.find(o=>o.ym===k)||{}).label||k; }
  else { sumEl.textContent=`${n} months`; }
}
function applyMonthFilters(force=false){
  if(!state.hasData) return;
  hideCustomRangePanel();
  if(force || state.monthDirty){
    state.monthDirty=false;
    updateAllFilterOptions(null);
    resetConversionPaging();
    renderAll();
  }
  updateResetButtonVisibility();
}

function hasActiveFilters(){
  if(!state.hasData) return false;
  if(state.monthSel.size) return true;
  if(state.customRange.active) return true;
  if(el.search && el.search.value.trim()) return true;
  for(const root of Object.values(el.dd||{})){
    if(!root) continue;
    if(root.querySelector('.dd-list input[type=checkbox]:checked')) return true;
  }
  return false;
}

function updateResetButtonVisibility(){
  if(!el.resetFiltersBtn) return;
  el.resetFiltersBtn.style.display = hasActiveFilters() ? 'inline-flex' : 'none';
}


/* dropdowns */
function ddBuild(root){
  root.innerHTML = `
    <div class="dd-control"><span class="dd-summary">All</span><span class="dd-chev">â–¾</span></div>
    <div class="dd-panel">
      <div class="dd-head">
        <label class="select-all"><input type="checkbox" class="dd-select-all"/><span>Select All</span></label>
        <input type="search" class="dd-search" placeholder="Type to search"/>
        <div class="rc">Record Count</div>
      </div>
      <div class="dd-list"></div>
      <div class="dd-empty">No results</div>
    </div>`;
  const control=root.querySelector('.dd-control');
  control.addEventListener('click', ()=>{
    const willOpen=!root.classList.contains('open');
    document.querySelectorAll('.dd.open').forEach(n=>n.classList.remove('open'));
    root.classList.toggle('open', willOpen);
    if(willOpen){ clampPanelRight(root.querySelector('.dd-panel')); root.querySelector('.dd-search').focus(); ddApplySearchFilter(root); }
  });
  root.querySelector('.dd-panel').addEventListener('click', (e)=> e.stopPropagation());
  const searchEl=root.querySelector('.dd-search');
  searchEl.addEventListener('input', ()=>ddApplySearchFilter(root));
  searchEl.addEventListener('search', ()=>ddApplySearchFilter(root));
  root.querySelector('.dd-select-all').addEventListener('change', (e)=>{
    const on = e.target.checked;
    const vis = root.querySelectorAll('.dd-item:not([hidden]) input[type=checkbox]');
    vis.forEach(cb=>cb.checked = on);
    ddUpdateSummary(root);
  });
}
function ddSetOptions(root, items, keepSel=true){
  if(!root.querySelector('.dd-panel')) ddBuild(root);
  const list=root.querySelector('.dd-list');
  const prevSel = keepSel ? new Set(ddGetSelected(root)) : new Set();
  list.innerHTML = items.map(({v,count})=>`
    <div class="dd-item" title="${escapeHtml(v)}">
      <label class="dd-left">
        <input type="checkbox" value="${escapeHtml(v)}" ${prevSel.has(String(v))?'checked':''}/>
        <span class="dd-text">${escapeHtml(v)}</span>
      </label>
      <button type="button" class="dd-only" data-val="${escapeHtml(v)}">ONLY</button>
      <div class="dd-count">${(count??0).toLocaleString()}</div>
    </div>`).join('');
  list.querySelectorAll('.dd-only').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const val=btn.getAttribute('data-val');
      root.querySelectorAll('input[type=checkbox]').forEach(cb=>cb.checked=(cb.value===val));
      ddUpdateSummary(root); root.classList.remove('open');
    });
  });
  list.querySelectorAll('input[type=checkbox]').forEach(cb=>{
    cb.addEventListener('change', ()=>{ ddUpdateSummary(root); ddSyncSelectAll(root); });
  });
  ddApplySearchFilter(root);
  ddUpdateSummary(root);
}
function ddGetSelected(root){ return Array.from(root.querySelectorAll('.dd-list input[type=checkbox]:checked')).map(cb=>cb.value); }
function ddUpdateSummary(root){
  const sel = ddGetSelected(root);
  root.querySelector('.dd-summary').textContent = sel.length===0 ? 'All' : sel.length===1 ? sel[0] : `${sel.length} selected`;
}
function ddSyncSelectAll(root){
  const vis=Array.from(root.querySelectorAll('.dd-item:not([hidden]) input[type=checkbox]'));
  root.querySelector('.dd-select-all').checked = (vis.length && vis.every(cb=>cb.checked));
}
function ddApplySearchFilter(root){
  if(!root) return;
  const searchEl=root.querySelector('.dd-search');
  const q=searchEl ? searchEl.value.trim().toLowerCase() : '';
  let matches=0;
  root.querySelectorAll('.dd-item').forEach(item=>{
    const text=item.querySelector('.dd-text');
    const txt=text?text.textContent.toLowerCase():'';
    const show=!q || txt.includes(q);
    item.hidden=!show;
    if(show) matches++;
  });
  root.classList.toggle('no-results', matches===0);
  ddSyncSelectAll(root);
}

function syncFilterLabels(){
  const labels=document.querySelectorAll('[data-col-label]');
  labels.forEach(label=>{
    const key=label.getAttribute('data-col-label');
    if(!key) return;
    const fallback=label.getAttribute('data-default') || label.textContent;
    const col=state.columns[key];
    const isAlias=col && col.aliasOf;
    label.textContent = col?.name || fallback;
    const wrapper=label.closest('[data-col-wrapper]');
    if(wrapper) wrapper.hidden = !col || isAlias;
  });
}

function initFilters(){
  syncFilterLabels();
  Object.values(el.dd).forEach(root=>root && ddBuild(root));
  buildOptionsAll();
  if(el.search){
    el.search.value='';
    el.search.addEventListener('input', debounce(()=>updateAllFilterOptions(null),150));
  }

  el.filters.hidden=false;
}
function buildOptionsAll(){
  for(const [k,root] of Object.entries(el.dd)){
    const col=state.columns[k];
    if(!col || col.aliasOf) continue;
    const values=uniqValues(k).map(v=>({v,count:0}));
    ddSetOptions(root, values, false);
  }
  updateAllFilterOptions(null);
}
function uniqValues(kind){
  const col=state.columns[kind]; if(!col || col.aliasOf) return [];
  const key=normalize(col.name); const set=new Set();
  state.rows.forEach(r=>{ const v=r[key]; if(v==null || v==="") return; set.add(String(v)); });
  return Array.from(set).sort((a,b)=>String(a).localeCompare(String(b)));
}
function optionsWithCounts(kind, rows){
  const col=state.columns[kind]; if(!col || col.aliasOf) return [];
  const key=normalize(col.name); const map=new Map();
  rows.forEach(r=>{ const v=r[key]; if(v==null||v==="") return; map.set(String(v),(map.get(String(v))||0)+1); });
  const root=el.dd[kind]; const selected=new Set(ddGetSelected(root));
  selected.forEach(v=>{ if(!map.has(v)) map.set(v,0); });
  return [...map.entries()].sort((a,b)=> b[1]-a[1] || String(a[0]).localeCompare(String(b[0])) ).map(([v,count])=>({v,count}));
}
function activeSelections(excludeRoot){
  const keyOf = n => state.columns[n] ? normalize(state.columns[n].name) : null;
  const act={};
  Object.entries(el.dd).forEach(([k,root])=>{
    const col=state.columns[k];
    if(!col || col.aliasOf) return;
    if(excludeRoot && root===excludeRoot) return;
    const vals=ddGetSelected(root); if(vals.length) act[keyOf(k)] = new Set(vals.map(String));
  });
  const dateKey=keyOf('date');
  let from=null, to=null;
  if(dateKey && state.customRange.active){
    from=cloneDate(state.customRange.start); if(from) from.setHours(0,0,0,0);
    to=cloneDate(state.customRange.end); if(to) to.setHours(23,59,59,999);
  }
  const monthSet=new Set(state.monthSel);
  return {act,dateKey,from,to,termKey:keyOf('term'),monthSet};
}
function rowsForFilterContext(excludeRoot){
  const {act,dateKey,from,to,termKey,monthSet}=activeSelections(excludeRoot);
  const needle=el.search.value.trim().toLowerCase();
  return state.rows.filter(r=>{
    if(needle && termKey){ const t=(r[termKey]??'').toString().toLowerCase(); if(!t.includes(needle)) return false; }
    if(dateKey && (from||to||monthSet.size)){
      const d=r[dateKey]; if(!(d instanceof Date)) return false;
      if(from && d<from) return false; if(to && d>to) return false;
      if(monthSet.size){ const ym=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; if(!monthSet.has(ym)) return false; }
    }
    for(const colKey in act){ if(!act[colKey].has(String(r[colKey]))) return false; }
    return true;
  });
}
function updateAllFilterOptions(excludeRoot){
  const base=rowsForFilterContext(excludeRoot||null);
  Object.entries(el.dd).forEach(([k,root])=>{
    const col=state.columns[k];
    if(!col || col.aliasOf) return;
    ddSetOptions(root, optionsWithCounts(k, base), true);
  });
}

/* ===== KPIs ===== */
function getFilteredRows(){ return rowsForFilterContext(null); }
function computeKPIs(rows){
  const k={
    imp:   state.columns.impressions ? normalize(state.columns.impressions.name) : null,
    clk:   state.columns.clicks ? normalize(state.columns.clicks.name) : null,
    rev:   state.columns.revenue ? normalize(state.columns.revenue.name) : null,
    spend: state.columns.spend ? normalize(state.columns.spend.name) : null
  };
  let I=0,C=0,R=0,S=0;
  for(const r of rows){ I+=(+r[k.imp]||0); C+=(+r[k.clk]||0); R+=(+r[k.rev]||0); S+=(+r[k.spend]||0); }
  const ctr = I>0 ? C/I : NaN;
  const acos = R>0 ? S/R : NaN;
  const roas = S>0 ? R/S : NaN;
  const avgcpc = C>0 ? S/C : NaN;
  return {I,C,R,S,ctr,acos,roas,avgcpc};
}
function buildKpiSeries(rows){
  const series={spend:[], revenue:[], acos:[], clicks:[], impressions:[], ctr:[], roas:[], avgcpc:[]};
  const dateCol=state.columns.date ? normalize(state.columns.date.name) : null;
  if(!Array.isArray(rows) || !rows.length || !dateCol) return series;
  const spendKey = state.columns.spend ? normalize(state.columns.spend.name) : null;
  const revenueKey = state.columns.revenue ? normalize(state.columns.revenue.name) : null;
  const clicksKey = state.columns.clicks ? normalize(state.columns.clicks.name) : null;
  const imprKey = state.columns.impressions ? normalize(state.columns.impressions.name) : null;
  const hasSpend=!!spendKey, hasRevenue=!!revenueKey, hasClicks=!!clicksKey, hasImpr=!!imprKey;
  const buckets=new Map();
  for(const row of rows){
    const d=row[dateCol];
    if(!(d instanceof Date)) continue;
    const key=`${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
    let bucket=buckets.get(key);
    if(!bucket){
      bucket={date:new Date(d.getFullYear(),d.getMonth(),d.getDate()), spend:0,revenue:0,clicks:0,impressions:0};
      buckets.set(key,bucket);
    }
    if(hasSpend) bucket.spend += +row[spendKey]||0;
    if(hasRevenue) bucket.revenue += +row[revenueKey]||0;
    if(hasClicks) bucket.clicks += +row[clicksKey]||0;
    if(hasImpr) bucket.impressions += +row[imprKey]||0;
  }
  const sorted=[...buckets.values()].sort((a,b)=>a.date-b.date);
  for(const entry of sorted){
    if(hasSpend) series.spend.push(entry.spend);
    if(hasRevenue) series.revenue.push(entry.revenue);
    if(hasSpend && hasRevenue) series.acos.push(entry.revenue>0 ? entry.spend/entry.revenue : NaN);
    if(hasClicks) series.clicks.push(entry.clicks);
    if(hasImpr) series.impressions.push(entry.impressions);
    if(hasClicks && hasImpr) series.ctr.push(entry.impressions>0 ? entry.clicks/entry.impressions : NaN);
    if(hasSpend && hasRevenue) series.roas.push(entry.spend>0 ? entry.revenue/entry.spend : NaN);
    if(hasSpend && hasClicks) series.avgcpc.push(entry.clicks>0 ? entry.spend/entry.clicks : NaN);
  }
  return series;
}
function renderKPIs(x, series){
  el.kpi.spend.textContent   = fmt.money0(x.S);
  el.kpi.revenue.textContent = fmt.money0(x.R);
  el.kpi.acos.textContent    = isFinite(x.acos) ? (x.acos*100).toFixed(2)+'%' : 'â€”';
  el.kpi.clicks.textContent  = fmt.int(x.C);
  el.kpi.impr.textContent    = fmt.int(x.I);
  el.kpi.ctr.textContent     = isFinite(x.ctr) ? (x.ctr*100).toFixed(2)+'%' : 'â€”';
  el.kpi.roas.textContent    = isFinite(x.roas) ? x.roas.toFixed(2)+'x' : 'â€”';
  el.kpi.avgcpc.textContent  = isFinite(x.avgcpc) ? fmt.money(x.avgcpc) : 'â€”';
  lastKpiSeries = series || null;
  updateKpiSparks(series);
}
function ensureKpiSparklines(){
  if(!el.kpis) return;
  const cards=el.kpis.querySelectorAll('.kpi[data-kpi]');
  cards.forEach(card=>{
    const key=card.getAttribute('data-kpi');
    if(!key || kpiSparkCache.has(key)) return;
    const canvas=document.createElement('canvas');
    canvas.className='kpi-spark';
    card.appendChild(canvas);
    const ctx=canvas.getContext('2d');
    kpiSparkCache.set(key,{card,canvas,ctx});
  });
}
function drawKpiSpark(meta, values){
  const {card,canvas,ctx}=meta||{};
  if(!card || !canvas || !ctx){ return; }
  const isSmall=card.classList.contains('small');
  const widthRatio=isSmall?0.48:0.45;
  const widthMax=isSmall?82:90;
  const widthMin=isSmall?48:54;
  const width=Math.max(widthMin, Math.min(widthMax, card.clientWidth*widthRatio));
  const heightPaddingTop=10;
  const heightPaddingBottom=8;
  const height=Math.max(36, card.clientHeight-(heightPaddingTop+heightPaddingBottom));
  const dpr=window.devicePixelRatio||1;
  canvas.width=Math.round(width*dpr);
  canvas.height=Math.round(height*dpr);
  canvas.style.width=`${width}px`;
  canvas.style.height=`${height}px`;
  ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.clearRect(0,0,width,height);
  const arr=Array.isArray(values)?values.filter(v=>Number.isFinite(v)):[];
  if(arr.length===0){ return; }
  let min=Math.min(...arr);
  let max=Math.max(...arr);
  if(!Number.isFinite(min) || !Number.isFinite(max)){ return; }
  if(max===min){
    const pad=Math.abs(max||1)*0.05 || 1;
    min-=pad; max+=pad;
  }else{
    const pad=(max-min)*0.08;
    min-=pad; max+=pad;
  }
  const points=[];
  const step=arr.length>1 ? width/(arr.length-1) : width/2;
  let idx=0;
  values.forEach(val=>{
    if(!Number.isFinite(val)) return;
    const x=arr.length>1 ? idx*step : width/2;
    const ratio=(val-min)/(max-min);
    const y=height - Math.max(0, Math.min(1, ratio))*height;
    points.push({x,y});
    idx++;
  });
  const accent=getComputedStyle(document.body).getPropertyValue('--accent').trim() || '#2563eb';
  ctx.lineWidth=2.4;
  ctx.lineJoin='round';
  ctx.lineCap='round';
  ctx.strokeStyle=accent;
  if(points.length<=1){
    const y=points.length?points[0].y:height/2;
    ctx.beginPath();
    ctx.moveTo(0,y);
    ctx.lineTo(width,y);
    ctx.stroke();
    return;
  }
  ctx.beginPath();
  ctx.moveTo(points[0].x, points[0].y);
  for(let i=1;i<points.length-1;i++){
    const xc=(points[i].x+points[i+1].x)/2;
    const yc=(points[i].y+points[i+1].y)/2;
    ctx.quadraticCurveTo(points[i].x, points[i].y, xc, yc);
  }
  ctx.lineTo(points[points.length-1].x, points[points.length-1].y);
  ctx.stroke();
}
function updateKpiSparks(series){
  ensureKpiSparklines();
  const metrics=['spend','revenue','acos','clicks','impressions','ctr','roas','avgcpc'];
  metrics.forEach(key=>{
    const meta=kpiSparkCache.get(key);
    if(!meta) return;
    const values=series && Array.isArray(series[key]) ? series[key] : [];
    drawKpiSpark(meta, values);
  });
}

function finalizeAgg(map, limit, options={}){
  if(!(map instanceof Map) || map.size===0){
    return {labels:[], spend:[], sales:[], acos:[], total:0, truncated:false, totalSpend:0, totalSales:0, limit:null, page:{start:0,count:0,size:0,current:0,totalPages:0,hasPrev:false,hasNext:false,total:0}};
  }
  const entries=[];
  let totalSpend=0;
  let totalSales=0;
  map.forEach((value,label)=>{
    const spend=+value.spend||0;
    const sales=+value.sales||0;
    const acos=sales>0 ? spend/sales : (spend>0 ? Infinity : NaN);
    entries.push({label:String(label), spend, sales, acos});
    totalSpend+=spend;
    totalSales+=sales;
  });
  const sortValue=v=>{
    if(Number.isNaN(v)) return Number.NEGATIVE_INFINITY;
    if(v===Infinity) return Number.POSITIVE_INFINITY;
    if(v===-Infinity) return Number.NEGATIVE_INFINITY;
    return v;
  };
  entries.sort((a,b)=>{
    if(b.sales!==a.sales) return b.sales - a.sales;
    const aAcos=sortValue(a.acos);
    const bAcos=sortValue(b.acos);
    if(bAcos>aAcos) return 1;
    if(bAcos<aAcos) return -1;
    return String(a.label).localeCompare(String(b.label));
  });
  const maxRows=(Number.isFinite(limit)&&limit>0)?Math.floor(limit):null;
  let output=entries;
  let pageMeta={start:0,count:entries.length,size:maxRows||entries.length,current:0,totalPages:maxRows?Math.ceil(entries.length/(maxRows||1)): (entries.length?1:0),hasPrev:false,hasNext:false,total:entries.length};
  if(maxRows){
    const totalPages=entries.length ? Math.ceil(entries.length/maxRows) : 0;
    let pageIndex=Number.isFinite(options.page)?Math.max(0, Math.floor(options.page)):0;
    if(totalPages>0){
      pageIndex=Math.min(pageIndex, totalPages-1);
    }else{
      pageIndex=0;
    }
    const start=pageIndex*maxRows;
    const end=start+maxRows;
    output=entries.slice(start,end);
    const count=output.length;
    pageMeta={
      start,
      count,
      size:maxRows,
      current:pageIndex,
      totalPages,
      hasPrev:start>0,
      hasNext:end<entries.length,
      total:entries.length
    };
  }
  const truncated=!!(maxRows && entries.length>output.length);
  return {
    labels:output.map(e=>e.label),
    spend:output.map(e=>e.spend),
    sales:output.map(e=>e.sales),
    acos:output.map(e=>e.acos),
    total:entries.length,
    truncated,
    totalSpend,
    totalSales,
    limit:maxRows,
    page:pageMeta
  };
}

function buildAgg(rows, keyCol, spendKey, salesKey){
  if(!Array.isArray(rows) || !rows.length || !keyCol){
    return {labels:[], spend:[], sales:[], acos:[]};
  }
  const agg=new Map();
  for(const r of rows){
    const label=String(r[keyCol] ?? '(Unspecified)');
    const spend=+r[spendKey]||0;
    const sales=+r[salesKey]||0;
    const entry=agg.get(label);
    if(entry){
      entry.spend+=spend;
      entry.sales+=sales;
    }else{
      agg.set(label,{spend,sales});
    }
  }
  return finalizeAgg(agg);
}

function updatePivotFootSpace(table){
  if(!table) return;
  const body = table.closest('.pivot-body');
  if(!body) return;
  const apply=()=>{
    const foot=table.querySelector('tfoot');
    if(!foot){
      body.style.setProperty('--pivot-foot-space','0px');
      schedulePivotLayout();
      return;
    }
    const rect=foot.getBoundingClientRect();
    const height=Math.ceil(rect.height||0);
    const gap=Math.max(0, height+12);
    body.style.setProperty('--pivot-foot-space', `${gap}px`);
    schedulePivotLayout();
  };
  if(typeof requestAnimationFrame==='function') requestAnimationFrame(apply);
  else apply();
}

function schedulePivotLayout(){
  if(typeof requestAnimationFrame!=='function'){
    updatePivotLayout();
    return;
  }
  if(pivotLayoutFrame) cancelAnimationFrame(pivotLayoutFrame);
  pivotLayoutFrame=requestAnimationFrame(()=>{
    pivotLayoutFrame=null;
    updatePivotLayout();
  });
}

function updatePivotLayout(){
  const section=el.pivot?.section;
  if(!section || section.hidden){
    return;
  }
  const cards=Array.from(section.querySelectorAll('.pivot-card'));
  if(!cards.length){
    section.style.removeProperty('--pivot-auto-rows');
    return;
  }
  const styles=getComputedStyle(section);
  let rowHeight=parseFloat(styles.getPropertyValue('--pivot-auto-rows'));
  if(!Number.isFinite(rowHeight) || rowHeight<=0){
    rowHeight=12;
    section.style.setProperty('--pivot-auto-rows', `${rowHeight}px`);
  }
  const rowGap=parseFloat(styles.rowGap)||0;
  const denom=rowHeight+rowGap;
  cards.forEach(card=>{
    if(card.hidden){
      card.style.removeProperty('grid-row-end');
      return;
    }
    const rect=card.getBoundingClientRect();
    const height=rect.height;
    if(!height){
      card.style.removeProperty('grid-row-end');
      return;
    }
    const span=Math.max(1, Math.ceil((height+rowGap)/(denom||1)));
    card.style.gridRowEnd=`span ${span}`;
  });
}

function renderPivotTable(table){
  if(!table) return;
  const data=table._pivotData;
  if(!data){
    table.innerHTML='';
    table.classList.remove('has-grand-total');
    updatePivotFootSpace(table);
    schedulePivotLayout();
    return;
  }

  const safeColumn=escapeHtml(data.displayName||'Group');
  const sort=table._pivotSort || (table._pivotSort={key:null,dir:'desc'});
  if(sort.key && !PIVOT_SORT_KEYS.has(sort.key)){
    sort.key=null;
  }
  if(sort.dir!=='asc' && sort.dir!=='desc'){
    sort.dir='desc';
  }

  const rows=Array.isArray(data.rows)?data.rows.slice():[];
  if(sort.key){
    rows.sort((a,b)=>comparePivotRows(a,b,sort.key,sort.dir));
  }

  const head=buildPivotHead(safeColumn, sort.key, sort.dir);

  if(!rows.length){
    table.innerHTML = head + `<tbody><tr><td colspan="5" class="pivot-empty">No ${safeColumn} data for current filters.</td></tr></tbody>`;
    table.classList.remove('has-grand-total');
    updatePivotFootSpace(table);
    schedulePivotLayout();
    return;
  }

  const barScale=Number.isFinite(data.barScale) && data.barScale>0 ? data.barScale : 100;
  const bodyRows=rows.map(row=>{
    const labelCell=`<th scope="row">${escapeHtml(row.label)}</th>`;
    const spendCell=buildPivotMoneyCell(row.spend);
    const salesCell=buildPivotMoneyCell(row.sales);
    const acosCells=buildPivotAcosCells(row.acos, barScale, false);
    return `<tr>${labelCell}${spendCell}${salesCell}${acosCells}</tr>`;
  }).join('');

  const totalSpend=Number(data.totals?.spend)||0;
  const totalSales=Number(data.totals?.sales)||0;
  const totalAcos=typeof data.totals?.acos==='number'?data.totals.acos:NaN;
  const totalRow=`<tr class="pivot-total"><th scope="row">Grand Total</th>${buildPivotMoneyCell(totalSpend)}${buildPivotMoneyCell(totalSales)}${buildPivotAcosCells(totalAcos, barScale, true)}</tr>`;

  table.innerHTML = head + `<tbody>${bodyRows}</tbody><tfoot>${totalRow}</tfoot>`;
  table.classList.add('has-grand-total');
  updatePivotFootSpace(table);
  schedulePivotLayout();
}

function buildPivotHead(columnLabel, activeKey, activeDir){
  const cells=[
    buildPivotHeadCell('label', columnLabel, '', activeKey, activeDir),
    buildPivotHeadCell('spend', 'Spend', '', activeKey, activeDir),
    buildPivotHeadCell('sales', 'Sales', '', activeKey, activeDir),
    buildPivotHeadCell('acos', 'ACOS', 'pivot-acos', activeKey, activeDir),
    '<th scope="col" class="pivot-acos-bar" aria-hidden="true"></th>'
  ];
  return `<thead><tr>${cells.join('')}</tr></thead>`;
}

function buildPivotHeadCell(key, title, extraClass, activeKey, activeDir){
  const sortable=PIVOT_SORT_KEYS.has(key);
  const classes=['pivot-sortable'];
  if(extraClass) classes.push(extraClass);
  const classAttr=sortable?` class="${classes.join(' ')}"`:(extraClass?` class="${extraClass}"`:'');
  const attrs=[`scope="col"`];
  if(sortable){
    attrs.push(`data-sort-key="${key}"`);
    attrs.push('role="button"');
    attrs.push('tabindex="0"');
  }
  if(sortable && activeKey===key){
    attrs.push(`aria-sort="${activeDir==='asc'?'ascending':'descending'}"`);
  }
  const indicator=(sortable && activeKey===key)?`<span class="pivot-sort-indicator" aria-hidden="true">${activeDir==='asc'?'â–²':'â–¼'}</span>`:'';
  const safeTitle=escapeHtml(title);
  return `<th ${attrs.join(' ')}${classAttr}><span class="pivot-sort-label">${safeTitle}${indicator}</span></th>`;
}

function buildPivotMoneyCell(value){
  return `<td class="pivot-num">${escapeHtml(fmt.money0(value))}</td>`;
}

function buildPivotAcosCells(value, barScale, isTotal){
  if(!Number.isFinite(value)){
    return '<td class="pivot-acos pivot-acos-empty">â€”</td><td class="pivot-acos-bar pivot-acos-empty"></td>';
  }
  const pct=value*100;
  const width=Math.max(0, Math.min(100, barScale ? (pct/barScale)*100 : 0));
  const cls=`pivot-amount${isTotal?' pivot-amount-total':''}`;
  const valueCell=`<td class="pivot-acos"><span class="${cls}">${pct.toFixed(1)}%</span></td>`;
  const barCell=`<td class="pivot-acos-bar"><div class="pivot-bar"><div class="pivot-bar-fill acos" style="width:${width}%"></div></div></td>`;
  return valueCell+barCell;
}

function comparePivotRows(a,b,key,dir){
  if(key==='label'){
    const cmp=PIVOT_LABEL_COLLATOR.compare(String(a.label??''), String(b.label??''));
    return dir==='desc' ? -cmp : cmp;
  }
  const va=pivotSortWeight(a[key]);
  const vb=pivotSortWeight(b[key]);
  if(va!==vb){
    const diff=va-vb;
    return dir==='desc' ? -diff : diff;
  }
  return PIVOT_LABEL_COLLATOR.compare(String(a.label??''), String(b.label??''));
}

function pivotSortWeight(value){
  if(typeof value!=='number' || Number.isNaN(value)) return -1e14;
  if(value===Infinity) return 1e15;
  if(value===-Infinity) return -1e15;
  return value;

}

function renderPivotCard(target, columnLabel, agg, hasColumn){
  if(!target || !target.card || !target.table) return false;
  if(!hasColumn){
    target.card.hidden = true;
    if(target.card.style) target.card.style.removeProperty('grid-row-end');
    target.table.innerHTML='';
    target.table._pivotData=null;
    target.table.classList.remove('has-grand-total');
    updatePivotFootSpace(target.table);
    schedulePivotLayout();
    setPivotNote(target.card, '');
    return false;
  }

  const displayName = columnLabel || 'Group';
  target.card.hidden = false;
  const titleTextNode = target.card.querySelector('.chart-title-text');
  if(titleTextNode) titleTextNode.textContent = `${displayName} Performance Pivot`;
  else{
    const fallbackTitle=target.card.querySelector('.chart-title');
    if(fallbackTitle) fallbackTitle.textContent = `${displayName} Performance Pivot`;

  }

  const labels = Array.isArray(agg?.labels) ? agg.labels : [];
  const spendVals = Array.isArray(agg?.spend) ? agg.spend.map(v=>+v||0) : labels.map(()=>0);
  const salesVals = Array.isArray(agg?.sales) ? agg.sales.map(v=>+v||0) : labels.map(()=>0);

  const parseAcosValue=(value)=>{
    if(typeof value==='number') return value;
    const str=String(value??'').trim();
    if(!str) return NaN;
    const cleaned=str.replace(/acos/ig,'').trim();
    if(!/[0-9]/.test(cleaned)) return NaN;
    const num=parseNumber(cleaned);
    return Number.isFinite(num)?num:NaN;
  };

  const acosVals = (Array.isArray(agg?.acos) && agg.acos.length===labels.length)
    ? agg.acos.map(parseAcosValue)
    : labels.map((_,i)=>{
        const sales=salesVals[i];
        const spend=spendVals[i];
        return sales>0 ? spend/sales : (spend>0 ? Infinity : NaN);
      });

  const totalSpend = Number.isFinite(agg?.totalSpend) ? agg.totalSpend : spendVals.reduce((sum,val)=>sum+val,0);
  const totalSales = Number.isFinite(agg?.totalSales) ? agg.totalSales : salesVals.reduce((sum,val)=>sum+val,0);
  const totalAcos = totalSales>0 ? totalSpend/totalSales : NaN;

  const totalCount=Number.isFinite(agg?.total)?agg.total:labels.length;
  const limit=Number.isFinite(agg?.limit)?agg.limit:null;
  let truncatedNote='';
  if(labels.length && limit && totalCount>labels.length && agg?.page){
    const start=Number.isFinite(agg.page.start)?agg.page.start:0;
    const from=Math.min(totalCount,start+1);
    const to=Math.min(totalCount,start+labels.length);
    truncatedNote=`Showing rows ${from.toLocaleString()}â€“${to.toLocaleString()} of ${totalCount.toLocaleString()} ${displayName} results. Totals include all filtered rows.`;
  }else if(agg?.truncated){
    const totalStr=totalCount.toLocaleString();
    const limitStr=(limit||labels.length).toLocaleString();
    truncatedNote=`Showing top ${limitStr} of ${totalStr} ${displayName} results. Totals include all filtered rows.`;
  }
  if(truncatedNote){
    setPivotNote(target.card, truncatedNote);
  }else{
    setPivotNote(target.card, '');
  }

  const finiteAcos = acosVals.filter(Number.isFinite);
  if(isFinite(totalAcos)) finiteAcos.push(totalAcos);
  const maxPct = finiteAcos.length ? Math.max(...finiteAcos)*100 : 0;
  const barMaxPct = Math.min(100, maxPct + 10);
  const barScale = barMaxPct > 0 ? barMaxPct : 100;

  const rowData = labels.map((label,i)=>({
    label:String(label),
    spend:spendVals[i],
    sales:salesVals[i],
    acos:acosVals[i]
  }));

  target.table._pivotData={
    displayName,
    rows:rowData,
    totals:{spend:totalSpend,sales:totalSales,acos:totalAcos},
    barScale
  };

  if(!target.table._pivotSort){
    target.table._pivotSort={key:null,dir:'desc'};
  }

  renderPivotTable(target.table);
  return true;
}

function renderConversionPivots(rows, spendKey, salesKey){
  const result={st:false,asin:false};
  const targetSt=el.pivot?.conversionSt;
  const targetAsin=el.pivot?.conversionAsin;
  const termCol=state.columns.term;
  const typeCol=state.columns.customerType;
  const hasBasics = !!(spendKey && salesKey && termCol && typeCol);
  const baseLabel = termCol?.name || 'Customer Search Term';

  if(!hasBasics){
    if(targetSt) renderPivotCard(targetSt, `${baseLabel} (ST)`, null, false);
    if(targetAsin) renderPivotCard(targetAsin, `${baseLabel} (ASIN)`, null, false);
    return result;
  }

  const termKey = normalize(termCol.name);
  const typeKey = normalize(typeCol.name);
  const normalizeTypeRaw = (value)=>String(value??'').trim().toLowerCase();
  const typeCache=new Map();
  const mapTypeValue=(value)=>{
    const raw=normalizeTypeRaw(value);
    if(typeCache.has(raw)) return typeCache.get(raw);
    let mapped;
    if(raw==='search term' || raw==='searchterm' || raw==='search-term' || raw==='st') mapped='st';
    else if(raw==='asin' || raw==='product asin' || raw==='product-asin') mapped='asin';
    else mapped=raw;
    typeCache.set(raw,mapped);
    return mapped;
  };

  const buckets={st:new Map(), asin:new Map()};
  for(const row of rows){
    const type=mapTypeValue(row[typeKey]);
    const bucket=type==='st'?buckets.st:type==='asin'?buckets.asin:null;
    if(!bucket) continue;
    const label=String(row[termKey] ?? '(Unspecified)');
    const spend=+row[spendKey]||0;
    const sales=+row[salesKey]||0;
    const entry=bucket.get(label);
    if(entry){
      entry.spend+=spend;
      entry.sales+=sales;
    }else{
      bucket.set(label,{spend,sales});
    }
  }

  const renderBucket=(target,map,labelSuffix,key)=>{
    if(!target) return false;
    if(!state.conversionPage) state.conversionPage={st:0,asin:0};
    const totalEntries=map instanceof Map ? map.size : 0;
    let pageIndex=state.conversionPage[key]||0;
    if(MAX_CONVERSION_ROWS && totalEntries>0){
      const totalPages=Math.ceil(totalEntries/MAX_CONVERSION_ROWS);
      if(pageIndex>=totalPages) pageIndex=Math.max(0,totalPages-1);
    }else{
      pageIndex=0;
    }
    state.conversionPage[key]=pageIndex;
    const agg=finalizeAgg(map, MAX_CONVERSION_ROWS, {page:pageIndex});
    updateConversionNav(target, agg);
    return renderPivotCard(target, `${baseLabel} (${labelSuffix})`, agg, true);
  };

  result.st = renderBucket(targetSt,buckets.st,'ST','st');
  result.asin = renderBucket(targetAsin,buckets.asin,'ASIN','asin');
  return result;
}

function hideUnusedPivotSlots(activeSlots){
  if(!el.pivot) return;
  Object.entries(el.pivot).forEach(([slot,target])=>{
    if(slot==='section') return;
    if(activeSlots.has(slot)) return;
    if(target?.card){
      target.card.hidden=true;
      target.card.style.removeProperty('grid-row-end');
    }
    if(target?.table){
      target.table.innerHTML='';
      target.table._pivotData=null;
      target.table.classList.remove('has-grand-total');
      updatePivotFootSpace(target.table);
    }
  });
}

/* ===== render & CSV ===== */
function renderAll(){
  const rows=getFilteredRows();
  const series=buildKpiSeries(rows);
  renderKPIs(computeKPIs(rows), series);

  const spendKey = state.columns.spend ? normalize(state.columns.spend.name) : null;
  const salesKey = state.columns.revenue ? normalize(state.columns.revenue.name) : null;
  if(el.pivot?.section) el.pivot.section.dataset.mode = state.activeTab || 'overview';

  const activeSlots=new Set();
  let anyPivot=false;

  if(state.activeTab==='conversion'){
    const result=renderConversionPivots(rows, spendKey, salesKey);
    if(result.st) activeSlots.add('conversionSt');
    if(result.asin) activeSlots.add('conversionAsin');
    anyPivot = result.st || result.asin;
  }else{
    const config=getPivotConfig();
    const visibilities=config.map(({slot,column,fallback})=>{
      const target=el.pivot?.[slot];
      if(!target) return false;
      const columnDef=state.columns[column];
      const columnName=columnDef?.name || fallback;
      const columnKey=columnDef ? normalize(columnDef.name) : null;
      const hasMetrics = spendKey && salesKey && columnKey;
      const agg = hasMetrics ? buildAgg(rows, columnKey, spendKey, salesKey) : null;
      const rendered = renderPivotCard(target, columnName, agg, !!columnKey);
      if(rendered) activeSlots.add(slot);
      return rendered;
    });
    anyPivot = visibilities.some(Boolean);
  }

  hideUnusedPivotSlots(activeSlots);

  if(el.pivot?.section) el.pivot.section.hidden = !anyPivot;
  updateResetButtonVisibility();
  schedulePivotLayout();
}

function onDownloadCsv(){
  const rows=getFilteredRows();
  if(!rows.length){ alert('No rows to download for current filters.'); return; }
  const headers=Object.keys(state.rows[0]||{});
  const esc=v=>{ if(v==null) return ''; const s=String(v); return /[",\n]/.test(s)?'"'+s.replace(/"/g,'""')+'"':s; };
  const head=headers.map(esc).join(',')+'\n';
  const body=rows.map(r=>headers.map(h=>esc(r[h])).join(',')).join('\n');
  const blob=new Blob([head+body],{type:'text/csv;charset=utf-8'});
  saveAs(blob,'filtered.csv');
}

/* ===== modal controls ===== */
function snapshotFilters(){
  const snap={};
  Object.entries(el.dd).forEach(([key,root])=>{
    if(!root) return;
    const col=state.columns[key];
    if(col && col.aliasOf) return;
    snap[key]=ddGetSelected(root);
  });
  snap.search=el.search.value;
  snap.customRange={
    active:state.customRange.active,
    start:state.customRange.start?toInputDate(state.customRange.start):'',
    end:state.customRange.end?toInputDate(state.customRange.end):''
  };
  state.snapshot=snap;
}
function restoreSnapshot(){
  const s=state.snapshot||{};
  Object.entries(el.dd).forEach(([key,root])=>{
    if(!root) return;
    const col=state.columns[key];
    if(col && col.aliasOf) return;
    const selected=Array.isArray(s[key])?s[key]:[];
    root.querySelectorAll('.dd-list input[type=checkbox]').forEach(cb=>cb.checked=selected.includes(cb.value));
    ddUpdateSummary(root);
    ddSyncSelectAll(root);
  });
  el.search.value=s.search??'';
  if(s.customRange){
    const start=parseInputDate(s.customRange.start);
    const end=parseInputDate(s.customRange.end);
    state.customRange={
      active:!!s.customRange.active && (start||end),
      start:start||null,
      end:end||null
    };
    if(state.customRange.active) state.monthSel.clear();
    syncCustomRangeInputs();
    updateMonthSummary();
  }
  updateAllFilterOptions(null);
  updateResetButtonVisibility();
}
function openFiltersModal(){ snapshotFilters(); el.modal.classList.add('open'); el.modal.setAttribute('aria-hidden','false'); }
function closeFiltersCancel(){ restoreSnapshot(); el.modal.classList.remove('open'); el.modal.setAttribute('aria-hidden','true'); }
function closeFiltersApply(){ el.modal.classList.remove('open'); el.modal.setAttribute('aria-hidden','true'); resetConversionPaging(); renderAll(); }
function clearAllFilters(){
  Object.values(el.dd).forEach(root=>{
    if(!root) return;
    root.querySelectorAll('.dd-list input[type=checkbox]').forEach(cb=>cb.checked=false);
    ddUpdateSummary(root);
    ddSyncSelectAll(root);
  });
  clearCustomRange({skipRender:true, skipFilters:true});
  el.search.value='';
  updateAllFilterOptions(null);
  updateMonthSummary();
  updateResetButtonVisibility();
}

function resetFiltersAndApply(){
  if(!state.hasData) return;
  if(!hasActiveFilters()) return;
  state.monthSel.clear();
  el.monthList?.querySelectorAll('input[type=checkbox]').forEach(cb=>cb.checked=false);
  state.monthDirty=false;
  clearCustomRange({skipRender:true, skipFilters:true});
  updateMonthSummary();
  if(el.monthDD) el.monthDD.classList.remove('open');
  clearAllFilters();
  resetConversionPaging();
  renderAll();
}

</script>
</body>
</html>
